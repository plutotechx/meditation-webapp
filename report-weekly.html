<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Executive Weekly Report - Meditation</title>
  <style>
    :root{
      --bg:#0a1322;
      /* สีพื้นหลังการ์ดที่เข้มและมีมิติแบบในรูป */
      --card-bg: #111826; 
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.65);

      /* สีตามระดับในรูปภาพ */
      --l1-color: #30d16a; /* เขียว */
      --l2-color: #f3c43a; /* ทอง */
      --l3-color: #ff8c2a; /* ส้ม */
      --l4-color: #ff4d4d; /* แดง */
      --l5-color: #ff4d4d; /* แดงเข้ม */

      --radius:16px;
      --shadow:0 4px 20px rgba(0,0,0,.5);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI","Noto Sans Thai",sans-serif;
      color:var(--text);
      background: #081224; /* พื้นหลังรวม */
      min-height:100vh;
      padding:20px;
      /* บังคับพิมพ์สีพื้นหลัง */
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    
    .page{ width:min(1280px, 100%); margin:0 auto; }

    /* --- Header Section --- */
    .hdr{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:20px;
    }
    .title h1{ margin:0; font-size:24px; font-weight:900; letter-spacing:0.5px; }
    .sub{ display:flex; gap:10px; font-size:12px; color:var(--muted); margin-top:6px; }
    
    .pill-info{
      background:rgba(255,255,255,0.1);
      padding:4px 10px; border-radius:99px;
      display:inline-flex; align-items:center; gap:6px;
    }
    .dot-live{
      width:8px; height:8px; background:var(--l1-color);
      border-radius:50%; box-shadow:0 0 8px var(--l1-color);
    }

    /* --- Action Buttons (Hidden on Print) --- */
    .actions{ display:flex; gap:12px; }
    .btn{
      background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.2);
      color:#fff; padding:8px 16px; border-radius:8px;
      cursor:pointer; text-decoration:none; font-weight:bold; font-size:13px;
    }
    .btn.primary{ background:#3b82f6; border-color:#2563eb; }
    .seg{ display:flex; background:#000; border-radius:99px; padding:4px; border:1px solid rgba(255,255,255,0.15); }
    .seg-btn{
      background:transparent; border:none; color:#aaa; 
      padding:6px 14px; border-radius:99px; cursor:pointer; font-weight:bold; font-size:12px;
    }
    .seg-btn.active{ background:#3b82f6; color:#fff; }

    /* --- Top Layout (Trend & Donut) --- */
    .top-grid{
      display:grid; grid-template-columns: 1.5fr 1fr; gap:16px; margin-bottom:16px;
    }
    
    .card{
      background: var(--card-bg);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      display:flex; flex-direction:column;
    }

    /* Trend Chart specific */
    .chart-header{ display:flex; justify-content:space-between; margin-bottom:16px; }
    .chart-title{ font-size:16px; font-weight:bold; }
    .chart-sub{ font-size:11px; color:var(--muted); margin-top:2px; }
    .trend-bars{
      display:grid; grid-template-columns:repeat(7, 1fr); gap:12px;
      height:100px; align-items:end;
    }
    .t-col{ display:flex; flex-direction:column; align-items:center; gap:6px; }
    .t-bar-bg{
      width:100%; height:80px; background:rgba(255,255,255,0.05);
      border-radius:6px; overflow:hidden; display:flex; align-items:flex-end;
    }
    .t-bar-fill{
      width:100%; background:linear-gradient(180deg, #22c55e 0%, #15803d 100%);
      border-top: 1px solid #4ade80;
    }
    .t-lbl{ font-size:11px; font-weight:bold; color:var(--muted); }
    .t-val{ font-size:10px; color:var(--muted); }

    /* Donut Chart specific */
    .donut-layout{ display:flex; align-items:center; justify-content:center; gap:24px; }
    .donut-chart{ width:100px; height:100px; position:relative; }
    .legend-box{ display:grid; gap:6px; }
    .l-row{ display:flex; justify-content:space-between; gap:12px; font-size:11px; color:var(--muted); }
    .l-label{ display:flex; align-items:center; gap:6px; }
    .dot{ width:8px; height:8px; border-radius:50%; }

    /* --- Bottom Layout (5 Buckets) --- */
    .buckets-grid{
      display:grid; grid-template-columns: repeat(5, 1fr); gap:12px;
    }
    
    .bucket-card{
      background: var(--card-bg);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 16px;
      display:flex; flex-direction:column;
    }

    /* Bucket Header */
    .b-header{ margin-bottom:12px; }
    .b-title{ font-size:13px; font-weight:900; color:#fff; margin-bottom:4px; }
    .b-range{ font-size:11px; font-weight:bold; color:rgba(255,255,255,0.7); }
    .b-desc{
      font-size:10px; line-height:1.4; color:rgba(255,255,255,0.5);
      margin-bottom:16px; min-height:56px; /* Align text blocks */
    }

    /* Stats Line: Count vs % */
    .b-stats{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:12px; font-size:12px; font-weight:bold;
    }
    .b-count{ color:#fff; font-size:13px; }
    .b-pct{ color:rgba(255,255,255,0.6); font-family:var(--mono); }

    /* Name List: 2 Columns Grid */
    .b-list{
      display:grid; 
      grid-template-columns: 1fr 1fr; /* Force 2 columns */
      gap: 8px;
      align-content: start;
    }
    
    /* Name Pill Style (Like image) */
    .n-pill{
      font-size: 10px; font-weight: 700;
      padding: 6px 4px;
      border-radius: 99px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: rgba(255,255,255,0.9);
      text-align: center;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* Specific Colors per Level */
    .n-pill.l1{ border-color: var(--l1-color); color:var(--l1-color); box-shadow:inset 0 0 10px rgba(48,209,106,0.1); }
    .n-pill.l2{ border-color: var(--l2-color); color:var(--l2-color); box-shadow:inset 0 0 10px rgba(243,196,58,0.1); }
    .n-pill.l3{ border-color: var(--l3-color); color:var(--l3-color); box-shadow:inset 0 0 10px rgba(255,140,42,0.1); }
    .n-pill.l4{ border-color: var(--l4-color); color:var(--l4-color); box-shadow:inset 0 0 10px rgba(255,77,77,0.1); }
    .n-pill.l5{ border-color: var(--l5-color); color:var(--l5-color); background:rgba(255,77,77,0.1); }

    /* Mobile */
    @media (max-width: 980px) {
      .top-grid, .buckets-grid { grid-template-columns: 1fr; }
    }

    /* --- PRINT Settings (A4 Landscape) --- */
    @page { size: A4 landscape; margin: 5mm; }
    
    @media print {
      body { 
        background-color: #081224 !important; /* Force Dark Background */
        padding: 0 !important;
      }
      .page { 
        width: 100% !important; max-width: none !important; margin:0 !important;
        transform: scale(0.93); transform-origin: top center; /* Fit perfectly */
      }
      .actions, .btn, .seg { display: none !important; }
      
      /* Make sure lists print fully */
      .b-list { overflow: visible !important; display: grid !important; }
      
      /* Ensure specific colors print */
      .card, .bucket-card {
        background-color: #111826 !important;
        border-color: #333 !important;
        page-break-inside: avoid;
      }
      .t-bar-fill { -webkit-print-color-adjust: exact; }
    }
  </style>
</head>

<body>
  <div class="page">
    
    <div class="hdr">
      <div class="title">
        <h1>Dashboard Meditation — Executive Weekly Report</h1>
        <div class="sub">
          <span class="pill-info" id="weekPill">Week: Loading...</span>
          <span class="pill-info"><span class="dot-live"></span><span id="updatedPill">Updated: --:--</span></span>
        </div>
      </div>
      <div class="actions">
        <div class="seg" role="tablist">
          <button class="seg-btn active" id="btnThis">This Week</button>
          <button class="seg-btn" id="btnLast">Last Week</button>
        </div>
        <a class="btn" href="/dashboard.html">Dashboard</a>
        <button class="btn primary" id="btnPrint">Export PDF</button>
      </div>
    </div>

    <div class="top-grid">
      <div class="card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Weekly Trend</div>
            <div class="chart-sub">% คนที่ "ครบ 3/3" ต่อวัน (จ.-อา.)</div>
          </div>
          <div class="pill-info" style="font-size:11px" id="trendAvg">เฉลี่ย: --%</div>
        </div>
        <div class="trend-bars" id="trendBars"></div>
      </div>

      <div class="card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Distribution (ระดับ % ต่อสัปดาห์)</div>
            <div class="chart-sub">ภาพรวม Compliance</div>
          </div>
        </div>
        <div class="donut-layout">
          <div class="donut-chart">
            <svg viewBox="0 0 36 36">
              <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#333" stroke-width="3"/>
              <g id="donutSegs"></g>
            </svg>
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;">
              <div style="font-size:14px;font-weight:900;color:#fff" id="donutCenter">--%</div>
              <div style="font-size:7px;color:#aaa">Compliance</div>
            </div>
          </div>
          <div class="legend-box" id="legend"></div>
        </div>
      </div>
    </div>

    <div class="buckets-grid">
      
      <div class="bucket-card">
        <div class="b-header">
          <div class="b-title">ระดับที่ 1 — Perfect Integrity</div>
          <div class="b-range">(100%) ทำสมาธิได้สมบูรณ์แบบ</div>
        </div>
        <div class="b-desc">สมาชิกในกลุ่มนี้มี Integrity ที่ยอดเยี่ยม แสดงถึงความสามารถในการนั่งสมาธิที่เข้าถึงอย่างสมบูรณ์ ทั้งในด้านความสงบ ความตั้งมั่น และการมีสติ</div>
        <div class="b-stats">
          <div class="b-count" id="b1Count">-- คน</div>
          <div class="b-pct" id="b1Pct">--%</div>
        </div>
        <div class="b-list" id="b1List"></div>
      </div>

      <div class="bucket-card">
        <div class="b-header">
          <div class="b-title">ระดับที่ 2 — Excellent</div>
          <div class="b-range">(90–99%) ดีมาก ใกล้เคียง 100%</div>
        </div>
        <div class="b-desc">สมาชิกในกลุ่มนี้มี Integrity ในการทำสมาธิ ถึงจะไม่ได้ผลลัพธ์สูงสุด 100% แต่ก็ใกล้เคียงมาก แสดงถึงการมีสมาธิที่ดีและความตั้งมั่น</div>
        <div class="b-stats">
          <div class="b-count" id="b2Count">-- คน</div>
          <div class="b-pct" id="b2Pct">--%</div>
        </div>
        <div class="b-list" id="b2List"></div>
      </div>

      <div class="bucket-card">
        <div class="b-header">
          <div class="b-title">ระดับที่ 3 — Good</div>
          <div class="b-range">(80–89%) ดี มีโอกาสพัฒนา</div>
        </div>
        <div class="b-desc">สมาชิกในกลุ่มนี้มี Integrity ในระดับกลาง ยังมีโอกาสในการพัฒนาเพิ่มเติม อาจเป็นกลุ่มที่ยังไม่ถึงระดับที่พึงพอใจอย่างเต็มที่</div>
        <div class="b-stats">
          <div class="b-count" id="b3Count">-- คน</div>
          <div class="b-pct" id="b3Pct">--%</div>
        </div>
        <div class="b-list" id="b3List"></div>
      </div>

      <div class="bucket-card">
        <div class="b-header">
          <div class="b-title">ระดับที่ 4 — Fair</div>
          <div class="b-range">(70–79%) ปานกลาง ควรฝึกเพิ่ม</div>
        </div>
        <div class="b-desc">สมาชิกในกลุ่มนี้มี Integrity ในระดับปานกลาง ยังไม่สามารถเข้าถึงสมาธิได้อย่างที่คาดหวัง จะต้องฝึกฝนเพิ่มเติม</div>
        <div class="b-stats">
          <div class="b-count" id="b4Count">-- คน</div>
          <div class="b-pct" id="b4Pct">--%</div>
        </div>
        <div class="b-list" id="b4List"></div>
      </div>

      <div class="bucket-card">
        <div class="b-header">
          <div class="b-title">ระดับที่ 5 — Needs Support</div>
          <div class="b-range">(&lt;69%) ค่อนข้างต่ำ ต้องการการสนับสนุน</div>
        </div>
        <div class="b-desc">สมาชิกในกลุ่มนี้มี Integrity ในระดับต่ำ การฝึกสมาธิยังไม่ค่อยประสบความสำเร็จ อาจมีปัญหาในการตั้งมั่นหรือการเข้าถึงสมาธิ</div>
        <div class="b-stats">
          <div class="b-count" id="b5Count">-- คน</div>
          <div class="b-pct" id="b5Pct">--%</div>
        </div>
        <div class="b-list" id="b5List"></div>
      </div>

    </div>

  </div>

<script>
  let WEEK_OFFSET = 0;
  
  const $ = (id)=> document.getElementById(id);
  const escapeHtml = (s)=> String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
  
  function thaiDateFromISO(iso){
    const [y,m,d] = String(iso||"").split("-").map(Number);
    if(!y||!m||!d) return "-";
    const dt = new Date(y,m-1,d);
    return dt.toLocaleDateString("th-TH",{day:"numeric",month:"short"});
  }
  function pct(n, total){ return total ? (n/total*100) : 0; }
  
  function buildTrend(peopleRows, week){
    const days = [];
    const [sy,sm,sd] = week.startISO.split("-").map(Number);
    const start = new Date(sy,sm-1,sd); start.setHours(0,0,0,0);
    for(let i=0;i<7;i++){
      const d = new Date(start); d.setDate(start.getDate()+i);
      const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      days.push(iso);
    }
    const total = peopleRows.length;
    return days.map(iso=>{
      let c=0;
      for(const p of peopleRows){
        const dd = (p.perDay||[]).find(x=>String(x.dateISO||"")===iso);
        if (dd && Number(dd.count||0)===3) c++;
      }
      return { iso, complete:c, pct: pct(c,total) };
    });
  }

  function renderTrend(tr){
    const host = $("trendBars");
    host.innerHTML = tr.map(x=>{
      const dayShort = new Date(x.iso).toLocaleDateString("th-TH",{weekday:"short"});
      const h = Math.max(0, Math.min(100, x.pct));
      return `
        <div class="t-col">
          <div class="t-bar-bg"><div class="t-bar-fill" style="height:${h}%"></div></div>
          <div class="t-lbl">${dayShort}.</div>
          <div class="t-val">${x.pct.toFixed(0)}%</div>
        </div>
      `;
    }).join("");
    const avg = tr.reduce((s,x)=>s+x.pct,0)/(tr.length||1);
    $("trendAvg").textContent = `เฉลี่ย: ${avg.toFixed(0)}%`;
  }

  function renderDonut(buckets, compliancePct, totalMembers){
    // Colors mapped to Levels
    const colors = ["#30d16a", "#f3c43a", "#ff8c2a", "#ff4d4d", "#b91c1c"];
    const counts = [buckets.b1.length, buckets.b2.length, buckets.b3.length, buckets.b4.length, buckets.b5.length];
    
    // SVG segments
    let accumulated = 0;
    const segments = counts.map((cnt, i) => {
       const p = pct(cnt, totalMembers);
       const dash = `${p} ${100 - p}`;
       const offset = 25 - accumulated; // start at top (25% offset)
       accumulated += p;
       return `<circle cx="18" cy="18" r="15.9155" fill="none" stroke="${colors[i]}" stroke-width="3" stroke-dasharray="${dash}" stroke-dashoffset="${offset}"></circle>`;
    }).join("");
    $("donutSegs").innerHTML = segments;
    $("donutCenter").textContent = `${compliancePct.toFixed(0)}%`;

    // Legend
    const labels = ["100%", "90-99%", "80-89%", "70-79%", "<69%"];
    $("legend").innerHTML = counts.map((c, i) => `
      <div class="l-row">
        <div class="l-label"><div class="dot" style="background:${colors[i]}"></div>${labels[i]}</div>
        <div>${c} คน</div>
      </div>
    `).join("");
  }

  function renderBucket(idPrefix, names, totalMembers, cls){
    $(idPrefix + "Count").textContent = `${names.length} คน`;
    $(idPrefix + "Pct").textContent = `${pct(names.length, totalMembers).toFixed(0)}%`;
    if(!names.length){
        $(idPrefix + "List").innerHTML = `<span style="grid-column:span 2;text-align:center;color:#555;font-size:10px">- ไม่มีรายการ -</span>`;
        return;
    }
    // No limit -> show all for print
    $(idPrefix + "List").innerHTML = names.map(n => `<div class="n-pill ${cls}">${escapeHtml(n)}</div>`).join("");
  }

  async function load(){
    try{
      $("weekPill").textContent = "Loading...";
      const res = await fetch(`/api/dashboard?weekOffset=${WEEK_OFFSET}`);
      const out = await res.json();
      if(!out.ok) return;

      const p = out.people || [];
      const total = p.length;
      
      // Compute buckets
      const buckets = { b1:[], b2:[], b3:[], b4:[], b5:[] };
      let sumDone=0, sumSlots=0;
      
      p.forEach(x => {
        const wp = Number(x.percent||0);
        sumDone += Number(x.totalDone||0);
        sumSlots += Number(x.totalSlots||21);
        
        if(wp >= 100) buckets.b1.push(x.name);
        else if(wp >= 90) buckets.b2.push(x.name);
        else if(wp >= 80) buckets.b3.push(x.name);
        else if(wp >= 70) buckets.b4.push(x.name);
        else buckets.b5.push(x.name);
      });
      
      // Sort names
      const sortFn = (a,b)=> a.localeCompare(b,'th');
      Object.values(buckets).forEach(arr => arr.sort(sortFn));

      // Header Info
      const w = out.week;
      $("weekPill").textContent = `Week: ${thaiDateFromISO(w.startISO)} - ${thaiDateFromISO(w.endISO)}`;
      const d = new Date();
      $("updatedPill").textContent = `Updated: ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

      // Render All
      renderTrend(buildTrend(p, w));
      renderDonut(buckets, (sumSlots ? sumDone/sumSlots*100 : 0), total);
      
      renderBucket("b1", buckets.b1, total, "l1");
      renderBucket("b2", buckets.b2, total, "l2");
      renderBucket("b3", buckets.b3, total, "l3");
      renderBucket("b4", buckets.b4, total, "l4");
      renderBucket("b5", buckets.b5, total, "l5");

    } catch(e){ console.error(e); }
  }

  $("btnThis").onclick = ()=>{ WEEK_OFFSET=0; updateBtns(); load(); };
  $("btnLast").onclick = ()=>{ WEEK_OFFSET=-1; updateBtns(); load(); };
  $("btnPrint").onclick = ()=>{ window.print(); };

  function updateBtns(){
    $("btnThis").className = `seg-btn ${WEEK_OFFSET===0?"active":""}`;
    $("btnLast").className = `seg-btn ${WEEK_OFFSET===-1?"active":""}`;
  }
  
  load();
</script>
</body>
</html>
