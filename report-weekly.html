<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Executive Weekly Report - Meditation</title>
  <style>
    :root{
      --bg:#0a1322;
      --card:rgba(255,255,255,.07);
      --border:rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);

      --good:#30d16a;
      --mid:#f3c43a;
      --orange:#ff8c2a;
      --bad:#ff4d4d;
      --none:rgba(255,255,255,.30);

      --radius:16px;
      /* ปรับเงาให้ดูนุ่มลึกเหมือนในภาพ */
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI","Noto Sans Thai",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 560px at 18% 0%, rgba(88,140,255,.14), transparent 60%),
        radial-gradient(900px 520px at 85% 12%, rgba(0,240,255,.10), transparent 55%),
        linear-gradient(180deg, #081224 0%, #070f1e 100%);
      min-height:100vh;
      padding:20px;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .page{ width:min(1200px, 100%); margin:0 auto; }

    /* Header & Action Bar */
    .hdr{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap; margin-bottom:16px;
    }
    .title{display:flex; flex-direction:column; gap:6px;}
    h1{ margin:0; font-size:22px; font-weight:950; letter-spacing:.3px; line-height:1.2; color:#fff; text-shadow:0 2px 10px rgba(0,0,0,.5); }
    .sub{ display:flex; gap:10px; flex-wrap:wrap; font-size:12px; color:var(--muted); align-items:center; }
    
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      white-space:nowrap; font-weight:700;
    }
    .dotLive{
      width:8px;height:8px;border-radius:999px;
      background:var(--good);
      box-shadow:0 0 0 0 rgba(48,209,106,.55);
      animation:pulseG 1.5s infinite;
      flex:0 0 auto;
    }
    @keyframes pulseG{
      0%{ box-shadow:0 0 0 0 rgba(48,209,106,.55) }
      70%{ box-shadow:0 0 0 8px rgba(48,209,106,0) }
      100%{ box-shadow:0 0 0 0 rgba(48,209,106,0) }
    }

    /* Buttons */
    .actions{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px; border-radius:12px;
      font-weight:800; cursor:pointer; text-decoration:none;
      font-size:13px; transition: all .2s;
    }
    .btn:hover{background:rgba(255,255,255,.15)}
    .btn.primary{
      background:rgba(106,169,255,.92);
      color:#071120;
      border-color:rgba(106,169,255,.35);
      box-shadow:0 10px 24px rgba(106,169,255,.2);
    }
    .seg{
      display:inline-flex; background:rgba(0,0,0,.3);
      border:1px solid rgba(255,255,255,.14); border-radius:999px; padding:4px; gap:2px;
    }
    .segBtn{
      border:0; border-radius:999px; padding:8px 14px;
      font-weight:800; color:rgba(234,240,255,.75); background:transparent;
      cursor:pointer; white-space:nowrap; font-size:12px; transition: all .2s;
    }
    .segBtn:hover{ color:#fff; }
    .segBtn.active{
      color:#071120; background:rgba(106,169,255,.95);
      box-shadow:0 4px 12px rgba(0,0,0,.3);
    }

    /* Grid Layouts */
    .grid{display:grid; grid-template-columns: 1fr; gap:16px;}
    .row2{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; align-items:stretch;}
    .rowBottom5{
      display:grid; 
      grid-template-columns: repeat(5, minmax(0,1fr)); 
      gap:12px; /* ช่องว่างระหว่างการ์ด */
      align-items:stretch; /* ยืดให้สูงเท่ากัน */
    }

    /* Universal Card Style */
    .card{
      background:linear-gradient(180deg, rgba(30,40,50,.7), rgba(20,25,35,.8));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      /* Minimum height to match visual weight */
      display:flex; flex-direction:column;
    }
    
    /* Top Charts Section */
    .cardHd{
      padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background:rgba(255,255,255,.02);
    }
    .cardHd .h{margin:0;font-size:14px;font-weight:950;color:#fff;letter-spacing:.2px;}
    .cardHd .m{font-size:11px;color:rgba(234,240,255,.6);margin-top:4px;font-weight:500;}
    .cardBd{padding:16px; position:relative; z-index:1; flex:1;}

    /* Trend Bar */
    .trendWrap{display:grid; gap:8px}
    .trend{
      display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:6px;
      align-items:end; height:100px; padding-top:6px;
    }
    .barCol{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:0;}
    .bar{
      width:100%; height:80px; border-radius:8px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
      overflow:hidden; display:flex; align-items:flex-end;
    }
    .bar > i{
      display:block; width:100%; height:0%;
      background:linear-gradient(180deg, #30d16a 0%, rgba(48,209,106,.5) 100%);
    }
    .barLbl{font-size:11px;font-weight:800;color:rgba(234,240,255,.8);line-height:1;}
    .barVal{font-size:10px;color:rgba(234,240,255,.5);font-family:var(--mono);}

    /* Donut */
    .dist{display:flex;gap:20px;align-items:center;justify-content:center;}
    .donut{width:110px;height:110px;flex:0 0 auto;}
    .centerText{font-size:15px;font-weight:1000;fill:#fff;}
    .legend{display:grid;gap:6px;min-width:140px}
    .legRow{display:flex;align-items:center;justify-content:space-between;gap:10px;font-size:11px;color:rgba(234,240,255,.8)}
    .legLeft{display:flex;align-items:center;gap:8px;min-width:0}
    .dot{width:8px;height:8px;border-radius:999px;}
    .dot.good{background:var(--good)} .dot.mid{background:var(--mid)}
    .dot.orange{background:var(--orange)} .dot.bad{background:var(--bad)}

    /* =========================================
       BUCKET CARDS (Matched to Image)
       ========================================= */
    .bucketCard{
      /* Ensure they stretch nicely */
      min-height: 420px; 
      background: rgba(18,24,34, 0.6); /* Slightly darker bg like image */
      border: 1px solid rgba(255,255,255,0.12);
    }
    .bucketCard .cardHd{
      background:transparent;
      border-bottom:none;
      padding: 16px 16px 4px 16px;
      flex-direction:column; gap:2px;
    }
    .bucketCard .cardHd .h{
      font-size:13px; font-weight:950; color:rgba(255,255,255,0.95);
    }
    .bucketRange{ display:block; margin-top:3px; font-size:11px; color:rgba(255,255,255,0.6); font-weight:800; }
    
    /* Description Text */
    .bucketDesc{
      padding: 0 16px;
      margin-top: 8px;
      font-size: 10.5px;
      line-height: 1.45;
      color: rgba(234,240,255,0.6);
      /* Fixed height block to align headers */
      min-height: 64px; 
    }

    /* Stats Line (Count | Percent) */
    .bucketMeta{
      padding: 0 16px;
      margin-top: 12px;
      margin-bottom: 12px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .bucketMeta .count{ font-size:12px; font-weight:950; color:#fff; }
    .bucketMeta .pct{ font-family:var(--mono); font-size:12px; font-weight:800; color:rgba(255,255,255,0.8); }

    /* Name List Container - The Core Fix */
    .bucketList {
      flex: 1; /* Fill remaining space */
      background: rgba(0,0,0,0.2); /* Darker inner background */
      margin: 0 8px 8px 8px; /* Gap from card edges */
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.05);

      /* ✅ GRID 2 COLUMNS: Force 2 columns for ALL buckets */
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px; 
      align-content: start; /* Items start at top */

      /* ✅ NO SCROLLBAR: Let it grow naturally */
      overflow: visible;
      height: auto;
      min-height: 100px;
    }

    /* Name Pills (Matched to Image) */
    .namePill{
      font-size: 10px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 99px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.05);
      color: rgba(234,240,255,0.9);
      
      width: 100%;
      text-align: center; /* Center text in pill */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      
      display: flex; align-items: center; justify-content: center;
    }
    /* Specific Colors per Level (Matched to Image) */
    .namePill.l1{ border-color:rgba(48,209,106,0.3); background:rgba(48,209,106,0.08); color:rgba(200,255,220,0.95); }
    .namePill.l2{ border-color:rgba(243,196,58,0.3); background:rgba(243,196,58,0.08); color:rgba(255,240,200,0.95); }
    .namePill.l3{ border-color:rgba(255,140,42,0.3); background:rgba(255,140,42,0.08); color:rgba(255,220,180,0.95); }
    .namePill.l4{ border-color:rgba(255,77,77,0.3);  background:rgba(255,77,77,0.08);  color:rgba(255,200,200,0.95); }
    .namePill.l5{ border-color:rgba(255,77,77,0.5);  background:rgba(255,77,77,0.15);  color:rgba(255,180,180,1.0); }
    .namePill.gray{ opacity:0.5; border:1px dashed rgba(255,255,255,0.2); background:transparent; }

    /* Mobile */
    @media (max-width: 980px){
      .row2{grid-template-columns:1fr}
      .rowBottom5{grid-template-columns:1fr; gap:16px;}
    }

    /* =========================================================================
       PRINT SETTINGS (A4 Landscape)
       ========================================================================= */
    @page { size: A4 landscape; margin: 6mm; }

    @media print {
      body {
        background: #081224 !important; /* Force dark bg */
        color: #eaf0ff !important;
        padding: 0 !important;
        -webkit-print-color-adjust: exact !important; 
        print-color-adjust: exact !important;
      }
      .page {
        width: 100% !important; max-width: none !important; margin: 0 !important;
        /* Scale to fit A4 width nicely */
        transform: scale(0.94); transform-origin: top center;
      }
      .actions, .btn, .seg { display: none !important; }
      
      .card, .bucketCard {
        border: 1px solid rgba(255,255,255,0.2) !important;
        background: rgba(30,40,50,1) !important; /* Solid dark for print */
        box-shadow: none !important;
        page-break-inside: avoid;
      }
      
      /* Ensure lists expand fully on print */
      .bucketList {
        overflow: visible !important;
        max-height: none !important;
        border: none !important;
        background: transparent !important;
      }
      
      .rowBottom5 { align-items: flex-start !important; }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="hdr">
      <div class="title">
        <h1>Dashboard Meditation — Executive Weekly Report</h1>
        <div class="sub">
          <span class="pill" id="weekPill">สัปดาห์: กำลังโหลด…</span>
          <span class="pill"><span class="dotLive"></span><span id="updatedPill">อัปเดตล่าสุด: —</span></span>
          <span class="pill" id="memberPill">สมาชิก: - คน</span>
        </div>
      </div>

      <div class="actions">
        <div class="seg" role="tablist">
          <button class="segBtn active" id="btnThis">สัปดาห์นี้</button>
          <button class="segBtn" id="btnLast">สัปดาห์ที่แล้ว</button>
        </div>
        <a class="btn" href="/dashboard.html">กลับไป Dashboard</a>
        <button class="btn primary" id="btnPrint">Export PDF (A4 แนวนอน)</button>
      </div>
    </div>

    <div class="grid">
      <div class="row2">
        <div class="card">
          <div class="cardHd">
            <div>
              <div class="h">Weekly Trend</div>
              <div class="m">% คนที่ “ครบ 3/3” ต่อวัน (จ.-อา.)</div>
            </div>
            <div class="pill" style="font-size:11px" id="trendAvg">เฉลี่ย: —%</div>
          </div>
          <div class="cardBd">
            <div class="trendWrap">
              <div class="trend" id="trendBars"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHd">
            <div>
              <div class="h">Distribution (ระดับ % ต่อสัปดาห์)</div>
              <div class="m">ภาพรวม Compliance</div>
            </div>
          </div>
          <div class="cardBd">
            <div class="dist">
              <svg class="donut" viewBox="0 0 120 120">
                <defs>
                  <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur stdDeviation="1.6" result="blur"/>
                    <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                  </filter>
                </defs>
                <circle cx="60" cy="60" r="44" fill="none" stroke="rgba(255,255,255,.16)" stroke-width="14"/>
                <g id="donutSegs" filter="url(#glow)"></g>
                <text x="60" y="58" text-anchor="middle" class="centerText" id="donutCenter">—%</text>
                <text x="60" y="74" text-anchor="middle" style="font-size:9px;fill:rgba(234,240,255,.7)">Compliance</text>
              </svg>
              <div class="legend" id="legend"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="rowBottom5">
        
        <div class="card bucketCard">
          <div class="cardHd">
            <div class="h">ระดับที่ 1 — Perfect Integrity</div>
            <span class="bucketRange">(100%) ทำสมาธิได้สมบูรณ์แบบ</span>
          </div>
          <div class="bucketDesc">สมาชิกในกลุ่มนี้มี Integrity ที่ยอดเยี่ยม แสดงถึงความสามารถในการนั่งสมาธิที่เข้าถึงอย่างสมบูรณ์ ทั้งในด้านความสงบ ความตั้งมั่น และการมีสติ</div>
          <div class="bucketMeta">
            <div class="count" id="b1Count">— คน</div>
            <div class="pct" id="b1Pct">—%</div>
          </div>
          <div class="bucketList" id="b1List"></div>
        </div>

        <div class="card bucketCard">
          <div class="cardHd">
            <div class="h">ระดับที่ 2 — Excellent</div>
            <span class="bucketRange">(90–99%) ดีมาก ใกล้เคียง 100%</span>
          </div>
          <div class="bucketDesc">สมาชิกในกลุ่มนี้มี Integrity ในการทำสมาธิ ถึงจะไม่ได้ผลลัพธ์สูงสุด 100% แต่ก็ใกล้เคียงมาก แสดงถึงความตั้งใจพัฒนาตนเองต่อไป</div>
          <div class="bucketMeta">
            <div class="count" id="b2Count">— คน</div>
            <div class="pct" id="b2Pct">—%</div>
          </div>
          <div class="bucketList" id="b2List"></div>
        </div>

        <div class="card bucketCard">
          <div class="cardHd">
            <div class="h">ระดับที่ 3 — Good</div>
            <span class="bucketRange">(80–89%) ดี มีโอกาสพัฒนา</span>
          </div>
          <div class="bucketDesc">สมาชิกในกลุ่มนี้มี Integrity ในระดับกลาง ยังมีโอกาสในการพัฒนาเพิ่มเติม อาจเป็นกลุ่มที่ยังไม่ถึงระดับที่พึงพอใจอย่างเต็มที่</div>
          <div class="bucketMeta">
            <div class="count" id="b3Count">— คน</div>
            <div class="pct" id="b3Pct">—%</div>
          </div>
          <div class="bucketList" id="b3List"></div>
        </div>

        <div class="card bucketCard">
          <div class="cardHd">
            <div class="h">ระดับที่ 4 — Fair</div>
            <span class="bucketRange">(70–79%) ปานกลาง ควรฝึกเพิ่ม</span>
          </div>
          <div class="bucketDesc">สมาชิกในกลุ่มนี้มี Integrity ในระดับปานกลาง ยังไม่สามารถเข้าถึงสมาธิได้อย่างที่คาดหวัง จะต้องฝึกฝนเพิ่มเติม</div>
          <div class="bucketMeta">
            <div class="count" id="b4Count">— คน</div>
            <div class="pct" id="b4Pct">—%</div>
          </div>
          <div class="bucketList" id="b4List"></div>
        </div>

        <div class="card bucketCard">
          <div class="cardHd">
            <div class="h">ระดับที่ 5 — Needs Support</div>
            <span class="bucketRange">(&lt;69%) ค่อนข้างต่ำ ต้องการการสนับสนุน</span>
          </div>
          <div class="bucketDesc">สมาชิกในกลุ่มนี้มี Integrity ในระดับต่ำ การฝึกสมาธิยังไม่ค่อยประสบความสำเร็จ อาจต้องการการสนับสนุนเพิ่มเติม</div>
          <div class="bucketMeta">
            <div class="count" id="b5Count">— คน</div>
            <div class="pct" id="b5Pct">—%</div>
          </div>
          <div class="bucketList" id="b5List"></div>
        </div>

      </div>
      
      <div class="note" style="margin-top:10px;text-align:right">*ข้อมูลอัปเดตแบบ Real-time</div>
    </div>
  </div>

<script>
  let WEEK_OFFSET = 0;
  const MAX_PER_BUCKET = 999; // Show ALL
  
  const $ = (id)=> document.getElementById(id);
  const escapeHtml = (s)=> String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
  
  function thaiDateFromISO(iso){
    const [y,m,d] = String(iso||"").split("-").map(Number);
    if(!y||!m||!d) return "-";
    const dt = new Date(y,m-1,d);
    return dt.toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"});
  }
  function nowHHmmTH(){
    const d = new Date();
    return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  }
  function pct(n, total){ return total ? (n/total*100) : 0; }
  function localTodayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function isPerfectWeek(perDay){
    const arr = Array.isArray(perDay) ? perDay : [];
    if (arr.length < 7) return false;
    return arr.every(d => Number(d.count||0) === 3);
  }
  function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || "#999"; }

  // Build Charts
  function buildTrend(peopleRows, week){
    const days = [];
    const [sy,sm,sd] = week.startISO.split("-").map(Number);
    const start = new Date(sy,sm-1,sd); start.setHours(0,0,0,0);
    for(let i=0;i<7;i++){
      const d = new Date(start); d.setDate(start.getDate()+i);
      const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      days.push(iso);
    }
    const total = peopleRows.length;
    return days.map(iso=>{
      let c=0;
      for(const p of peopleRows){
        const dd = (p.perDay||[]).find(x=>String(x.dateISO||"")===iso);
        if (dd && Number(dd.count||0)===3) c++;
      }
      return { iso, complete:c, pct: pct(c,total) };
    });
  }
  function renderTrend(tr){
    const host = $("trendBars");
    host.innerHTML = tr.map(x=>{
      const dayShort = new Date(x.iso).toLocaleDateString("th-TH",{weekday:"short"});
      const h = Math.max(0, Math.min(100, x.pct));
      return `
        <div class="barCol">
          <div class="bar"><i style="height:${h}%"></i></div>
          <div class="barLbl">${dayShort}</div>
          <div class="barVal">${x.pct.toFixed(0)}%</div>
        </div>
      `;
    }).join("");
    const avg = tr.reduce((s,x)=>s+x.pct,0)/(tr.length||1);
    $("trendAvg").textContent = `เฉลี่ย: ${avg.toFixed(0)}%`;
  }
  function renderDonut5(buckets, compliancePct, totalMembers){
    const segHost = $("donutSegs");
    segHost.innerHTML = "";
    const r = 44, c = 2 * Math.PI * r;
    const segs = [
      { color:getCSS("--good"),   pct:pct(buckets.b1.length, totalMembers) },
      { color:getCSS("--mid"),    pct:pct(buckets.b2.length, totalMembers) },
      { color:getCSS("--orange"), pct:pct(buckets.b3.length, totalMembers) },
      { color:"rgba(255,77,77,.28)", pct:pct(buckets.b4.length, totalMembers) },
      { color:getCSS("--bad"),    pct:pct(buckets.b5.length, totalMembers) },
    ];
    let offset = 0;
    segs.forEach(s=>{
      const len = (Math.max(0, s.pct) / 100) * c;
      const dash = `${len} ${c - len}`;
      const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
      circle.setAttribute("cx","60"); circle.setAttribute("cy","60"); circle.setAttribute("r", String(r));
      circle.setAttribute("fill","none"); circle.setAttribute("stroke", s.color);
      circle.setAttribute("stroke-width","14"); circle.setAttribute("stroke-linecap","round");
      circle.setAttribute("stroke-dasharray", dash);
      circle.setAttribute("stroke-dashoffset", String(-offset));
      circle.setAttribute("transform","rotate(-90 60 60)");
      segHost.appendChild(circle);
      offset += len;
    });
    $("donutCenter").textContent = `${Number(compliancePct||0).toFixed(0)}%`;
    const leg = $("legend");
    const rows = [
      { label:"100%",     dot:"good",   val:`${buckets.b1.length} คน` },
      { label:"90–99%",   dot:"mid",    val:`${buckets.b2.length} คน` },
      { label:"80–89%",   dot:"orange", val:`${buckets.b3.length} คน` },
      { label:"70–79%",   dot:"bad",    val:`${buckets.b4.length} คน` },
      { label:"<69%",     dot:"bad",    val:`${buckets.b5.length} คน` },
    ];
    leg.innerHTML = rows.map(r=>`
      <div class="legRow">
        <div class="legLeft"><span class="dot ${r.dot}"></span><span>${r.label}</span></div>
        <span>${escapeHtml(r.val)}</span>
      </div>
    `).join("");
  }
  
  // Render Bucket Lists
  function renderBucket(idPrefix, names, totalMembers, pillClass){
    const countEl = $(idPrefix + "Count");
    const pctEl   = $(idPrefix + "Pct");
    const listEl  = $(idPrefix + "List");
    countEl.textContent = `${names.length} คน`;
    pctEl.textContent = `${pct(names.length, totalMembers).toFixed(0)}%`;

    if (!names.length){
      // Make placeholder span 2 columns
      listEl.innerHTML = `<span class="namePill gray" style="grid-column:span 2">ไม่มีรายการ</span>`;
      return;
    }
    listEl.innerHTML = names.map(n=>`<span class="namePill ${pillClass}">${escapeHtml(n)}</span>`).join("");
  }
  
  function compute(out){
    const people = Array.isArray(out.people) ? out.people : [];
    const totalMembers = people.length;
    const week = out.week || { startISO:"-", endISO:"-" };
    const sum = out.summary && out.summary.thisWeek ? out.summary.thisWeek : null;
    let totalDoneAll = 0, totalSlots = totalMembers * 21;
    if (sum && Number.isFinite(Number(sum.totalDoneAll))) totalDoneAll = Number(sum.totalDoneAll);
    else totalDoneAll = people.reduce((s,p)=> s + Number(p.totalDone||0), 0);
    if (sum && Number.isFinite(Number(sum.totalSlots))) totalSlots = Number(sum.totalSlots);
    else totalSlots = people.reduce((s,p)=> s + Number(p.totalSlots||21), 0);
    const compliance = totalSlots ? (totalDoneAll/totalSlots*100) : 0;
    const buckets = { b1:[], b2:[], b3:[], b4:[], b5:[] };
    let riskN = 0, perfectN = 0;
    const todayISO = localTodayISO();
    const dayISO = (todayISO >= week.startISO && todayISO <= week.endISO) ? todayISO : week.startISO;
    let todayComplete = 0;
    for (const p of people){
      const wp = Number(p.percent||0);
      if (wp >= 100) buckets.b1.push(p.name);
      else if (wp >= 90) buckets.b2.push(p.name);
      else if (wp >= 80) buckets.b3.push(p.name);
      else if (wp >= 70) buckets.b4.push(p.name);
      else buckets.b5.push(p.name);
      if (wp < 80) riskN++;
      if (isPerfectWeek(p.perDay)) perfectN++;
      const dd = (p.perDay||[]).find(x=>String(x.dateISO||"")===dayISO);
      if (dd && Number(dd.count||0)===3) todayComplete++;
    }
    const thSort = (a,b)=> String(a).localeCompare(String(b),"th");
    buckets.b1.sort(thSort); buckets.b2.sort(thSort); buckets.b3.sort(thSort); buckets.b4.sort(thSort); buckets.b5.sort(thSort);
    const trend = buildTrend(people, week);
    return { week,totalMembers,compliance,buckets,riskN,todayComplete,dayISO,perfectN,trend };
  }
  function renderAll(out){
    const c = compute(out);
    $("weekPill").textContent = `สัปดาห์: ${thaiDateFromISO(c.week.startISO)} – ${thaiDateFromISO(c.week.endISO)}`;
    $("memberPill").textContent = `สมาชิก: ${c.totalMembers} คน`;
    $("updatedPill").textContent = `อัปเดต: ${nowHHmmTH()} น.`;
    renderTrend(c.trend);
    renderDonut5(c.buckets, c.compliance, c.totalMembers);
    renderBucket("b1", c.buckets.b1, c.totalMembers, "l1");
    renderBucket("b2", c.buckets.b2, c.totalMembers, "l2");
    renderBucket("b3", c.buckets.b3, c.totalMembers, "l3");
    renderBucket("b4", c.buckets.b4, c.totalMembers, "l4");
    renderBucket("b5", c.buckets.b5, c.totalMembers, "l5");
  }

  // Load Logic
  let loadSeq = 0;
  async function load(){
    const seq = ++loadSeq;
    try{
      $("weekPill").textContent = "กำลังโหลด...";
      const res = await fetch(`/api/dashboard?weekOffset=${WEEK_OFFSET}`, { cache:"no-store" });
      const out = await res.json().catch(()=>({}));
      if (seq !== loadSeq) return;
      if (!out.ok){
        ["b1List","b2List","b3List","b4List","b5List"].forEach(id=> $(id).innerHTML=`<span class="namePill gray" style="grid-column:span 2">โหลดไม่สำเร็จ</span>`);
        return;
      }
      renderAll(out);
    }catch(e){
      if (seq !== loadSeq) return;
    }
  }

  $("btnThis").onclick = ()=>{ WEEK_OFFSET=0; updateBtns(); load(); };
  $("btnLast").onclick = ()=>{ WEEK_OFFSET=-1; updateBtns(); load(); };
  $("btnPrint").onclick = ()=>{ window.print(); };

  function updateBtns(){
    $("btnThis").className = `segBtn ${WEEK_OFFSET===0?"active":""}`;
    $("btnLast").className = `segBtn ${WEEK_OFFSET===-1?"active":""}`;
  }
  load();
</script>
</body>
</html>
