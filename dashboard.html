<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Daily Meditation</title>
  <style>
    :root{
      /* --- Unified Theme Variables --- */
      --bg:#081224;
      --card-bg: #111826;
      --border: rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.65);

      --good:#30d16a;
      --mid:#f3c43a;
      --orange:#ff8c2a;
      --bad:#ff4d4d;
      --none:rgba(255,255,255,.28);

      --radius:16px;
      --shadow:0 4px 20px rgba(0,0,0,.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI","Noto Sans Thai",sans-serif;
      background: var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:20px;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .wrap{width:min(1280px, 100%); margin:0 auto;}

    /* --- Header --- */
    .topRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; flex-wrap:wrap; margin-bottom:20px;
    }
    .titleRow h1{ margin:0; font-size:24px; font-weight:900; letter-spacing:0.5px; }
    
    .pill-info{
      background:rgba(255,255,255,0.1);
      padding:4px 12px; border-radius:99px;
      display:inline-flex; align-items:center; gap:8px;
      font-size:13px; font-weight:700; color:var(--muted);
      margin-top:6px;
    }
    .dot-live{
      width:8px; height:8px; background:var(--good);
      border-radius:50%; box-shadow:0 0 8px var(--good);
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%{opacity:1} 50%{opacity:.5} 100%{opacity:1} }

    /* --- Controls --- */
    .weekMenu{ display:flex; gap:10px; }
    .seg{ 
      display:flex; background:#000; border-radius:99px; padding:4px; 
      border:1px solid rgba(255,255,255,0.15); 
    }
    .seg-btn{
      background:transparent; border:none; color:#aaa; 
      padding:8px 16px; border-radius:99px; cursor:pointer; 
      font-weight:bold; font-size:13px; white-space:nowrap;
    }
    .seg-btn.active{ background:#3b82f6; color:#fff; box-shadow:0 2px 10px rgba(59,130,246,0.4); }
    
    .btn{
      background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.2);
      color:#fff; padding:8px 16px; border-radius:99px;
      cursor:pointer; text-decoration:none; font-weight:bold; font-size:13px;
      display:inline-flex; align-items:center; height:42px;
    }
    .btn:hover{ background:rgba(255,255,255,0.15); }

    /* --- KPI Grid --- */
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:16px;
      margin-bottom:24px;
      align-items:start;
    }

    .kpi{
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      display:flex; flex-direction:column;
    }

    .kpiHead{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px; }
    .label{ font-size:14px; color:var(--muted); font-weight:800; }
    .countBadge{
      font-size:12px; font-weight:800; padding:4px 10px;
      border-radius:999px; background:rgba(255,255,255,.1);
      color:#fff; border:1px solid rgba(255,255,255,.1);
    }

    /* --- Pie Chart --- */
    .pieWrap{ display:flex; gap:20px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .pie{
      width:110px; height:110px; border-radius:50%;
      position:relative; flex:0 0 auto;
    }
    .pieSvg{ width:100%; height:100%; transform:rotate(-90deg); }
    .pieTrack{ fill:none; stroke:rgba(255,255,255,0.05); stroke-width:12; }
    .pieSeg{
      fill:none; stroke-width:12; stroke-linecap:round;
      transition: stroke-dasharray .6s ease;
    }
    .pieSeg.good{ stroke:var(--good); }
    .pieSeg.bad{ stroke:var(--bad); }
    .pieSeg.none{ stroke:var(--none); }
    
    .pieCenter{
      position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
      text-align:center;
    }
    .pieCenterBig{ font-size:22px; font-weight:900; color:#fff; line-height:1; }
    .pieCenterSub{ font-size:10px; color:var(--muted); margin-top:2px; }

    .legend{ display:grid; gap:8px; }
    .legendRow{ display:flex; align-items:center; gap:8px; font-size:12px; color:rgba(234,240,255,0.8); }
    .dot{ width:8px; height:8px; border-radius:50%; }
    .dot.good{ background:var(--good); }
    .dot.bad{ background:var(--bad); }
    .dot.none{ background:var(--none); }

    /* Compare Bar */
    .cmpWrap{ margin-top:20px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.08); }
    .cmpTitle{ font-size:12px; color:var(--muted); margin-bottom:10px; font-weight:700; }
    .cmpGrid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .cmpLbl{ font-size:11px; font-weight:700; color:#fff; margin-bottom:4px; }
    .cmpBar{ height:6px; background:rgba(255,255,255,0.1); border-radius:99px; overflow:hidden; }
    .cmpBar i{ display:block; height:100%; background:var(--good); width:0%; border-radius:99px; }
    .cmpVal{ font-size:11px; margin-top:4px; color:rgba(255,255,255,0.6); font-family:var(--mono); }
    .cmpDelta{ margin-top:10px; font-size:11px; font-weight:700; color:var(--muted); }
    .cmpDelta .up{ color:var(--good); } .cmpDelta .down{ color:var(--bad); }

    /* --- Lists (Weekly & Daily) --- */
    /* ✅ FIXED: No Max-Height on Desktop to prevent scrollbars */
    .wkList, .nameList { 
      display:grid; 
      gap:8px; 
      max-height: none !important; 
      overflow: visible !important; 
    }
    
    .wkRow{
      display:grid; grid-template-columns: 1fr auto;
      background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06);
      padding:10px 12px; border-radius:12px; align-items:center;
    }
    .wkDay{ font-size:13px; font-weight:700; color:#fff; }
    .wkBarWrap{ margin-top:6px; height:6px; background:rgba(255,255,255,0.1); border-radius:99px; overflow:hidden; grid-column:1/-1; }
    .wkBarWrap i{ display:block; height:100%; background:var(--good); width:0; }
    .wkStat{ font-size:12px; font-weight:700; color:rgba(255,255,255,0.8); }

    .nameSection{ margin-top:16px; }
    .secTitle{ font-size:12px; font-weight:800; color:var(--muted); margin-bottom:8px; }
    
    .nameList{ display:flex; flex-wrap:wrap; gap:6px; }
    .nameItem{
      font-size:11px; font-weight:700; padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1);
      color:rgba(234,240,255,0.9);
    }
    .nameItem.bad{ border-color:rgba(255,77,77,0.3); color:#ffcccc; background:rgba(255,77,77,0.1); }
    .nameItem.good{ border-color:rgba(48,209,106,0.3); color:#d1fae5; background:rgba(48,209,106,0.1); } /* For consistency list */

    /* --- Main Table --- */
    .weekTitle{ font-size:18px; font-weight:900; margin:20px 0 12px; color:#fff; }
    
    .tableWrap{
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .table{ width:100%; border-collapse:collapse; }
    .table th{
      text-align:left; padding:16px; font-size:13px; font-weight:900;
      color:rgba(255,255,255,0.7); background:rgba(0,0,0,0.2);
      border-bottom:1px solid var(--border);
    }
    .table td{
      padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.05);
      vertical-align:middle;
    }
    .table tr:last-child td{ border-bottom:none; }
    
    .name{ font-size:14px; font-weight:900; color:#fff; }
    
    .pctRow{ display:flex; align-items:center; gap:12px; }
    .chip{
      font-size:11px; font-weight:800; padding:4px 8px; border-radius:6px;
      background:rgba(255,255,255,0.1); color:#fff; min-width:60px; text-align:center;
    }
    .chip.good{ background:rgba(48,209,106,0.15); color:var(--good); }
    .chip.mid{ background:rgba(243,196,58,0.15); color:var(--mid); }
    .chip.bad{ background:rgba(255,77,77,0.15); color:var(--bad); }
    
    .progress{
      flex:1; height:6px; background:rgba(255,255,255,0.1); border-radius:99px; overflow:hidden;
      max-width:120px;
    }
    .progress i{ display:block; height:100%; background:var(--good); width:0; }
    .progress.mid i{ background:var(--mid); }
    .progress.bad i{ background:var(--bad); }

    .days{ display:grid; grid-template-columns:repeat(7, 1fr); gap:6px; }
    .daybox{
      background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1);
      border-radius:8px; text-align:center; padding:6px 2px;
      font-size:12px; font-weight:900; color:rgba(255,255,255,0.5);
      cursor:default;
    }
    .daybox.s3{ background:rgba(48,209,106,0.2); border-color:var(--good); color:#fff; }
    .daybox.s2{ background:rgba(243,196,58,0.2); border-color:var(--mid); color:#fff; }
    .daybox.s1{ background:rgba(255,140,42,0.2); border-color:var(--orange); color:#fff; }
    .daybox.s0{ background:rgba(255,77,77,0.15); border-color:rgba(255,77,77,0.4); color:rgba(255,200,200,0.8); }

    .btns{ display:flex; justify-content:flex-end; gap:12px; margin-top:24px; }

    /* --- Tooltip --- */
    .hoverTip{
      position:fixed; z-index:9999; display:none; pointer-events:none;
      background:rgba(15,23,42,0.95); border:1px solid rgba(255,255,255,0.2);
      border-radius:12px; padding:12px; backdrop-filter:blur(8px);
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
      min-width:180px; color:#fff;
    }
    .hoverTip.show{ display:block; }
    .tipHeader{ font-size:13px; font-weight:900; color:var(--muted); margin-bottom:8px; text-align:center; }
    .tipRow{ display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px; }
    .tipVal{ font-family:var(--mono); color:#fff; }

    /* --- Mobile --- */
    @media (max-width: 900px) {
      .page{ padding:10px; }
      .kpis{ grid-template-columns:1fr; }
      .topRow{ flex-direction:column; align-items:stretch; }
      .weekMenu{ justify-content:center; }
      .table thead{ display:none; }
      .table tr{ display:block; border-bottom:1px solid rgba(255,255,255,0.1); padding:16px; }
      .table td{ display:block; padding:4px 0; border:none; }
      .table td:first-child{ font-size:16px; margin-bottom:8px; }
      .days{ gap:4px; }
    }

    /* --- PRINT (A4 Landscape) --- */
    @page { size: A4 landscape; margin: 6mm; }
    @media print {
      body { background:#081224 !important; padding:0 !important; width:1100px; zoom:0.75; }
      .wrap { max-width:none !important; width:100% !important; margin:0 !important; }
      .topRow, .btns { display:none !important; }
      .kpis { display:grid !important; grid-template-columns: repeat(3, 1fr) !important; gap:12px !important; }
      .card, .tableWrap { background:#111826 !important; border:1px solid #333 !important; page-break-inside:avoid; }
      .table th { color:#ccc !important; }
      .table td { color:#fff !important; }
      .nameList, .wkList { max-height:none !important; overflow:visible !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    
    <div class="topRow">
      <div class="titleRow">
        <h1>Dashboard Meditation</h1>
        <div class="pill-info">
          <span class="dot-live"></span>
          <span>อัปเดต <span id="lastUpdated">--:--</span> น.</span>
        </div>
      </div>

      <div class="weekMenu">
        <div class="seg" role="tablist">
          <button id="btnThis" class="seg-btn active">This Week</button>
          <button id="btnLast" class="seg-btn">Last Week</button>
        </div>
      </div>
    </div>

    <div class="kpis">
      
      <div class="kpi">
        <div class="kpiHead">
          <div class="label" id="dailyPieLabel">สัดส่วนวันนี้</div>
        </div>
        <div class="pieWrap">
          <div class="pie">
            <svg class="pieSvg" viewBox="0 0 100 100">
              <circle class="pieTrack" cx="50" cy="50" r="40"></circle>
              <circle id="pieSegGood" class="pieSeg good" cx="50" cy="50" r="40" stroke-dasharray="0 251"></circle>
              <circle id="pieSegBad" class="pieSeg bad" cx="50" cy="50" r="40" stroke-dasharray="0 251"></circle>
              <circle id="pieSegNone" class="pieSeg none" cx="50" cy="50" r="40" stroke-dasharray="0 251"></circle>
            </svg>
            <div class="pieCenter">
              <div class="pieCenterBig" id="pieCenterBig">--%</div>
              <div class="pieCenterSub">Complete</div>
            </div>
          </div>
          <div class="legend">
            <div class="legendRow"><span class="dot good"></span><span id="lgGood">ครบ: -</span></div>
            <div class="legendRow"><span class="dot bad"></span><span id="lgBad">ไม่ครบ: -</span></div>
            <div class="legendRow"><span class="dot none"></span><span id="lgNone">0 ครั้ง: -</span></div>
          </div>
        </div>

        <div class="cmpWrap">
          <div class="cmpTitle">เทียบกับเมื่อวาน</div>
          <div class="cmpGrid">
            <div>
              <div class="cmpLbl" id="cmpTodayLabel">วันนี้</div>
              <div class="cmpBar"><i id="cmpBarToday"></i></div>
              <div class="cmpVal" id="cmpTodayPct">--%</div>
            </div>
            <div>
              <div class="cmpLbl" id="cmpPrevLabel">เมื่อวาน</div>
              <div class="cmpBar"><i id="cmpBarPrev" style="background:rgba(255,255,255,0.3)"></i></div>
              <div class="cmpVal" id="cmpPrevPct">--%</div>
            </div>
          </div>
          <div class="cmpDelta" id="cmpDelta">--</div>
        </div>
      </div>

      <div class="kpi">
        <div class="kpiHead">
          <div class="label" id="weeklyCompleteLabel">สรุป “ครบ 3 ครั้ง” รายวัน</div>
          <div class="countBadge" id="weeklyCompleteMeta">--%</div>
        </div>
        <div class="wkList" id="weeklyCompleteList">
          <span style="font-size:12px;color:#666">Loading...</span>
        </div>
      </div>

      <div class="kpi">
        <div class="kpiHead">
          <div class="label" id="card3Label">ทำไม่ครบวันนี้</div>
          <div class="countBadge" id="card3Count">-</div>
        </div>

        <div class="nameSection">
          <div class="secTitle" id="sec1Title">ทำไม่ครบ (1–2 ครั้ง)</div>
          <div class="nameList" id="sec1List"></div>
        </div>

        <div class="nameSection" id="sec2Wrap">
          <div class="secTitle" id="sec2Title">ไม่ทำเลย (0 ครั้ง)</div>
          <div class="nameList" id="sec2List"></div>
        </div>
      </div>

    </div>

    <div class="weekTitle" id="weekHeader">Week: --</div>
    <div class="tableWrap">
      <table class="table">
        <thead>
          <tr>
            <th width="25%">ชื่อ</th>
            <th width="35%">ความคืบหน้า (สัปดาห์)</th>
            <th width="10%">วันครบ</th>
            <th width="30%">รายวัน (จ. – อา.)</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" style="text-align:center;padding:20px;color:#666">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="btns">
      <a class="btn" href="/">กลับหน้าบันทึก</a>
      <a class="btn" href="/status.html">ตรวจสอบสถานะ</a>
      <button class="btn" style="background:#3b82f6" id="btnPrint">พิมพ์รายงาน (PDF)</button>
    </div>

  </div>

  <div class="hoverTip" id="hoverTip">
    <div class="tipHeader" id="tipHdr">-</div>
    <div id="tipBody"></div>
  </div>

<script>
  let WEEK_OFFSET = 0;
  
  const $ = (id)=> document.getElementById(id);
  const escapeHtml = (s)=> String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
  
  function thaiDateFromISO(iso){
    const [y,m,d] = String(iso||"").split("-").map(Number);
    if(!y||!m||!d) return "-";
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"});
  }
  function pct(n, total){ return total ? (n/total*100) : 0; }

  // Pie Chart Logic
  function updatePie(pGood, pBad, pNone){
    const C = 2 * Math.PI * 40; 
    const lGood = (pGood/100)*C;
    const lBad  = (pBad/100)*C;
    const lNone = (pNone/100)*C;

    const sGood = $("pieSegGood");
    const sBad  = $("pieSegBad");
    const sNone = $("pieSegNone");

    sGood.style.strokeDasharray = `${lGood} ${C}`;
    sGood.style.strokeDashoffset = 0;

    sBad.style.strokeDasharray = `${lBad} ${C}`;
    sBad.style.strokeDashoffset = -lGood;

    sNone.style.strokeDasharray = `${lNone} ${C}`;
    sNone.style.strokeDashoffset = -(lGood + lBad);
  }

  // Tooltip Logic
  const tip = $("hoverTip");
  function showTip(evt, iso, sessions){
    const h = $("tipHdr");
    const b = $("tipBody");
    const dayName = new Date(iso).toLocaleDateString("th-TH",{weekday:"long",day:"numeric",month:"short"});
    h.textContent = dayName;
    
    const s = sessions || {};
    const row = (lbl, ok, time) => `
      <div class="tipRow">
        <span style="color:${ok?'#4ade80':'#f87171'}">${lbl}</span>
        <span class="tipVal">${ok ? (time||'ok')+' น.' : '-'}</span>
      </div>`;
    
    b.innerHTML = 
      row("เช้า", s.s1?.done, s.s1?.time) +
      row("บ่าย", s.s2?.done, s.s2?.time) +
      row("ค่ำ", s.s3?.done, s.s3?.time);

    tip.classList.add("show");
    moveTip(evt);
  }
  function moveTip(evt){
    tip.style.left = (evt.clientX + 10) + "px";
    tip.style.top  = (evt.clientY + 10) + "px";
  }
  function hideTip(){ tip.classList.remove("show"); }

  async function load(){
    try{
      $("weekHeader").textContent = "Loading...";
      const res = await fetch(`/api/dashboard?weekOffset=${WEEK_OFFSET}`);
      const out = await res.json();
      if(!out.ok) return;

      const w = out.week;
      const people = out.people || [];
      const total = people.length;

      // 1. Date Logic
      const today = new Date();
      const todayISO = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      const showISO = (todayISO >= w.startISO && todayISO <= w.endISO) ? todayISO : w.endISO;

      // 2. Card 1: Pie Chart & Compare
      let completeN=0, partialN=0, noneN=0;
      people.forEach(p => {
        const d = (p.perDay||[]).find(x => x.dateISO === showISO);
        const cnt = d ? (d.count||0) : 0;
        if(cnt===3) completeN++;
        else if(cnt>0) partialN++;
        else noneN++;
      });

      const pGood = pct(completeN, total);
      const pBad = pct(partialN, total);
      const pNone = pct(noneN, total);
      
      updatePie(pGood, pBad, pNone);
      $("pieCenterBig").textContent = `${pGood.toFixed(0)}%`;
      $("lgGood").textContent = `ครบ: ${completeN}`;
      $("lgBad").textContent = `ไม่ครบ: ${partialN}`;
      $("lgNone").textContent = `0 ครั้ง: ${noneN}`;
      $("dailyPieLabel").textContent = `สัดส่วน (${thaiDateFromISO(showISO)})`;

      // Compare Stats
      const prevDate = new Date(showISO); prevDate.setDate(prevDate.getDate()-1);
      const prevISO = prevDate.toISOString().split('T')[0];
      let prevCompleteN = 0;
      people.forEach(p => {
        const d = (p.perDay||[]).find(x => x.dateISO === prevISO);
        if(d && d.count===3) prevCompleteN++;
      });
      const pPrev = pct(prevCompleteN, total);
      
      $("cmpTodayPct").textContent = `${completeN} (${pGood.toFixed(0)}%)`;
      $("cmpBarToday").style.width = `${pGood}%`;
      $("cmpPrevPct").textContent = `${prevCompleteN} (${pPrev.toFixed(0)}%)`;
      $("cmpBarPrev").style.width = `${pPrev}%`;
      
      const diff = pGood - pPrev;
      $("cmpDelta").innerHTML = diff >= 0 
        ? `<span style="color:var(--good)">▲ ดีขึ้น ${diff.toFixed(0)}%</span>` 
        : `<span style="color:var(--bad)">▼ ลดลง ${Math.abs(diff).toFixed(0)}%</span>`;

      // 3. Card 2: Weekly Trend
      const days = [];
      const start = new Date(w.startISO);
      for(let i=0; i<7; i++){
        const d = new Date(start); d.setDate(start.getDate()+i);
        days.push(d.toISOString().split('T')[0]);
      }
      
      $("weeklyCompleteList").innerHTML = days.map(iso => {
        let c=0;
        people.forEach(p => {
           const d = (p.perDay||[]).find(x => x.dateISO===iso);
           if(d && d.count===3) c++;
        });
        const pDay = pct(c, total);
        return `
          <div class="wkRow">
            <div class="wkDay">${thaiDateFromISO(iso)}</div>
            <div class="wkBarWrap"><i style="width:${pDay}%"></i></div>
            <div class="wkStat">${c} คน (${pDay.toFixed(0)}%)</div>
          </div>`;
      }).join("");

      // ============================================================
      // 4. Card 3: Logic Switch (Today vs Last Week)
      // ============================================================
      const renderList = (el, names, cls) => {
        el.innerHTML = names.length 
          ? names.sort().map(n => `<div class="nameItem ${cls}">${escapeHtml(n)}</div>`).join("") 
          : `<span style="color:#666;font-size:12px">- ไม่มี -</span>`;
      };

      if(WEEK_OFFSET === 0) {
        // --- THIS WEEK: Show Incomplete (Operational View) ---
        $("card3Label").textContent = "ทำไม่ครบวันนี้";
        $("sec1Title").textContent = "ทำไม่ครบ (1–2 ครั้ง)";
        $("sec2Title").textContent = "ไม่ทำเลย (0 ครั้ง)";
        $("sec2Wrap").style.display = "block";

        const partialNames = [], noneNames = [];
        people.forEach(p => {
          const d = (p.perDay||[]).find(x => x.dateISO === showISO);
          const cnt = d ? d.count : 0;
          if(cnt>0 && cnt<3) partialNames.push(p.name);
          if(cnt===0) noneNames.push(p.name);
        });

        renderList($("sec1List"), partialNames, "bad");
        renderList($("sec2List"), noneNames, "");
        $("card3Count").textContent = `${partialNames.length + noneNames.length}`;

      } else {
        // --- LAST WEEK: Show Consistent Users (KPI View) ---
        $("card3Label").textContent = "ผู้ทำสม่ำเสมอ (สัปดาห์)";
        $("sec1Title").textContent = "ทำครบ 100% (Perfect)";
        $("sec2Wrap").style.display = "none"; // Hide second section

        const consistentNames = [];
        people.forEach(p => {
          if((p.percent||0) >= 100) consistentNames.push(p.name);
        });

        renderList($("sec1List"), consistentNames, "good");
        $("card3Count").textContent = `${consistentNames.length}`;
      }

      // 5. Main Table
      $("weekHeader").textContent = `Week: ${thaiDateFromISO(w.startISO)} - ${thaiDateFromISO(w.endISO)}`;
      const tbody = $("tbody");
      tbody.innerHTML = "";
      
      people.sort((a,b) => (b.percent||0) - (a.percent||0) || a.name.localeCompare(b.name, 'th'));

      people.forEach(p => {
        const pc = p.percent || 0;
        const grade = pc >= 90 ? 'good' : pc >= 70 ? 'mid' : 'bad';
        
        const boxes = days.map(iso => {
          const d = (p.perDay||[]).find(x => x.dateISO === iso);
          const c = d ? d.count : 0;
          return `<div class="daybox s${c}" onmouseenter='showTip(event,"${iso}",${JSON.stringify(d?.sessions)})' onmouseleave='hideTip()'>${c}</div>`;
        }).join("");

        tbody.innerHTML += `
          <tr>
            <td class="name">${escapeHtml(p.name)}</td>
            <td>
              <div class="pctRow">
                <span class="chip ${grade}">${pc}%</span>
                <div class="progress ${grade}"><i style="width:${pc}%"></i></div>
              </div>
            </td>
            <td style="font-weight:900;color:#fff">${p.doneDays}/7</td>
            <td><div class="days">${boxes}</div></td>
          </tr>
        `;
      });

      const now = new Date();
      $("lastUpdated").textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

    } catch(e){ console.error(e); }
  }

  $("btnThis").onclick = ()=>{ WEEK_OFFSET=0; updateBtns(); load(); };
  $("btnLast").onclick = ()=>{ WEEK_OFFSET=-1; updateBtns(); load(); };
  $("btnPrint").onclick = ()=>{ window.print(); };

  function updateBtns(){
    $("btnThis").className = `seg-btn ${WEEK_OFFSET===0?"active":""}`;
    $("btnLast").className = `seg-btn ${WEEK_OFFSET===-1?"active":""}`;
  }

  load();
</script>
</body>
</html>
