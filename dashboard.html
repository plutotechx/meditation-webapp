<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Daily Meditation</title>

  <style>
    :root{
      --bg:#0a1322;
      --card:rgba(255,255,255,.07);
      --border:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);

      --good:#30d16a;
      --mid:#f3c43a;
      --bad:#ff4d4d;

      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:
        radial-gradient(1200px 600px at 25% 0%, rgba(88,140,255,.16), transparent 60%),
        radial-gradient(900px 500px at 80% 15%, rgba(0,240,255,.12), transparent 55%),
        linear-gradient(180deg, #081224 0%, #070f1e 100%);
      color:var(--text);
      min-height:100vh;
    }

    .wrap{max-width:1180px;margin:0 auto;padding:26px 18px 30px}
    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom:8px;
    }
    h1{margin:0;font-size:28px;font-weight:900;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .weekTitle{font-size:20px;font-weight:900;margin:12px 0 12px}

    /* ===== Auto Refresh Box (fixed height - กันกระตุก) ===== */
    .arBox{
      min-width:320px;
      max-width:420px;
      width:clamp(320px, 34vw, 420px);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px 14px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      height:78px; /* สำคัญ: คงที่ กัน box สั้นลง */
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .arLeft{display:flex;flex-direction:column;gap:6px;min-width:0}
    .arTitleRow{display:flex;align-items:center;gap:10px}
    .arTitle{font-weight:900}
    .arSub{font-size:12px;color:rgba(234,240,255,.72);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:5px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      font-weight:900;
      font-size:12px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:var(--bad);
      box-shadow:0 0 0 0 rgba(255,77,77,.35);
      animation:pulseRed 1.1s infinite;
    }
    .dot.on{
      background:var(--good);
      box-shadow:0 0 0 0 rgba(48,209,106,.35);
      animation:pulseGreen 1.1s infinite;
    }
    @keyframes pulseGreen{
      0%{box-shadow:0 0 0 0 rgba(48,209,106,.35)}
      70%{box-shadow:0 0 0 10px rgba(48,209,106,0)}
      100%{box-shadow:0 0 0 0 rgba(48,209,106,0)}
    }
    @keyframes pulseRed{
      0%{box-shadow:0 0 0 0 rgba(255,77,77,.35)}
      70%{box-shadow:0 0 0 10px rgba(255,77,77,0)}
      100%{box-shadow:0 0 0 0 rgba(255,77,77,0)}
    }

    /* Toggle */
    .switch{
      position:relative;
      width:56px;height:30px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      border-radius:999px;
      cursor:pointer;
      flex:0 0 auto;
    }
    .switch i{
      position:absolute;top:50%;left:4px;
      width:22px;height:22px;border-radius:999px;
      background:rgba(234,240,255,.92);
      transform:translateY(-50%);
      transition:all .18s ease;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
    }
    .switch.on{background:rgba(48,209,106,.25); border-color:rgba(48,209,106,.35)}
    .switch.on i{left:30px}

    /* ===== KPI cards ===== */
    .kpis{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:14px;
      margin:10px 0 16px;
    }
    @media (max-width:900px){ .kpis{grid-template-columns:1fr;}}

    .kpi{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:16px 16px 14px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute; inset:-2px;
      background:radial-gradient(closest-side at 65% 0%, rgba(120,200,255,.25), transparent 70%);
      pointer-events:none;
    }
    .kpi .label{font-size:14px;color:var(--muted);font-weight:800}
    .kpi .value{font-size:44px;font-weight:900;line-height:1;margin-top:10px}
    .kpi .sub{margin-top:10px;font-size:12px;color:rgba(234,240,255,.6)}
    .value.good{color:var(--good)}
    .value.bad{color:var(--bad)}

    /* ===== Table ===== */
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      box-shadow:0 18px 60px rgba(0,0,0,.35);
    }
    .table thead th{
      text-align:left;
      font-size:14px;
      font-weight:900;
      color:rgba(234,240,255,.82);
      padding:14px 14px;
      background:rgba(0,0,0,.20);
      border-bottom:1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }
    .table tbody td{
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
    }
    .table tbody tr:last-child td{border-bottom:none}
    .name{font-size:16px;font-weight:900}

    /* percent cell */
    .pctRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:12px;
      font-weight:900;border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      min-width:110px;justify-content:center;
    }
    .dotMini{width:12px;height:12px;border-radius:999px;background:var(--mid)}
    .chip.good{color:#dfffe9}
    .chip.good .dotMini{background:var(--good)}
    .chip.mid{color:#fff5d0}
    .chip.mid .dotMini{background:var(--mid)}
    .chip.bad{color:#ffd9d9}
    .chip.bad .dotMini{background:var(--bad)}

    .progress{
      width:min(280px, 100%);
      height:10px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .progress > i{display:block;height:100%;width:0%}
    .progress.good > i{background:linear-gradient(90deg, rgba(48,209,106,.95), rgba(48,209,106,.55))}
    .progress.mid > i{ background:linear-gradient(90deg, rgba(243,196,58,.95), rgba(243,196,58,.55))}
    .progress.bad > i{ background:linear-gradient(90deg, rgba(255,77,77,.95), rgba(255,77,77,.55))}
    .subline{margin-top:8px;font-size:12px;color:rgba(234,240,255,.66)}

    /* ===== 7 day boxes ===== */
    .days{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:10px;
      min-width:560px;
      align-items:start;
    }
    @media (max-width:1100px){ .days{min-width:440px} }
    @media (max-width:900px){ .days{grid-template-columns:repeat(4, minmax(0, 1fr)); min-width:unset} }

    .daybox{
      border-radius:12px;
      padding:10px 8px 10px;
      text-align:center;
      font-weight:900;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      user-select:none;
      position:relative;
      cursor:default;
    }
    .daybox.good{
      background:linear-gradient(180deg, rgba(48,209,106,.35), rgba(48,209,106,.18));
      border-color:rgba(48,209,106,.35);
    }
    .daybox.mid{
      background:linear-gradient(180deg, rgba(243,196,58,.30), rgba(243,196,58,.16));
      border-color:rgba(243,196,58,.35);
    }
    .daybox.bad{
      background:linear-gradient(180deg, rgba(255,77,77,.30), rgba(255,77,77,.15));
      border-color:rgba(255,77,77,.35);
    }

    .dayTop{
      display:flex;align-items:center;justify-content:space-between;
      gap:6px;margin-bottom:8px;
    }
    .dowBadge{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      line-height:1;
      white-space:nowrap;
    }
    .dayNum{
      font-size:13px;
      opacity:.9;
    }
    .dayCount{
      font-size:20px;
      letter-spacing:.3px;
    }

    /* ===== Hover Tooltip (fixed + clamp ไม่ให้ล้ำจอ) ===== */
    .hoverTip{
      position:fixed;
      z-index:99999;
      display:none;
      width:360px;
      max-width:calc(100vw - 24px);
      background:rgba(10,16,26,.96);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      box-shadow:0 18px 55px rgba(0,0,0,.55);
      padding:12px 12px 10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color:var(--text);
      overflow:hidden;
    }
    .hoverTip.show{display:block}
    .hoverTip .hdr{
      font-weight:900;
      margin-bottom:10px;
      color:rgba(234,240,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tipRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      margin-bottom:8px;
      min-width:0;
    }
    .tipLeft{
      display:flex;align-items:center;gap:10px;
      font-weight:900;
      min-width:0;
    }
    .ico{
      width:26px;height:26px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.18);
      flex:0 0 auto;
    }
    .ico.ok{background:rgba(48,209,106,.20); border-color:rgba(48,209,106,.35)}
    .ico.no{background:rgba(255,77,77,.18); border-color:rgba(255,77,77,.35)}
    .ico span{font-size:14px;line-height:1}
    .tipLabel{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tipTime{
      font-weight:900;
      opacity:.95;
      white-space:nowrap;
      flex:0 0 auto;
    }

    .hoverTip .arrow{
      position:absolute;
      width:12px;height:12px;
      background:rgba(10,16,26,.96);
      border-left:1px solid rgba(255,255,255,.14);
      border-top:1px solid rgba(255,255,255,.14);
      transform:rotate(45deg);
      top:-7px;
      left:50%;
      margin-left:-6px;
    }

    .btns{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap}
    .btn{
      text-decoration:none;color:var(--text);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 14px;border-radius:12px;
      font-weight:900;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topRow">
      <h1>Dashboard</h1>

      <!-- Auto Refresh box -->
      <div class="arBox" id="arBox" aria-live="polite">
        <div class="arLeft">
          <div class="arTitleRow">
            <span class="pill">
              <span class="dot" id="arDot"></span>
              <span id="arState">Auto Refresh</span>
            </span>
            <span class="pill" id="arMode">Active</span>
          </div>
          <div class="arSub" id="arSub">กำลังเตรียม...</div>
        </div>
        <div class="switch on" id="arSwitch" role="switch" aria-checked="true" tabindex="0"><i></i></div>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="label">ทำครบ 21/21</div>
        <div id="kpiComplete" class="value good">-</div>
        <div class="sub">จำนวนคนที่ครบทุกวันทุกเวลา</div>
      </div>

      <div class="kpi">
        <div class="label">ทำไม่ครบ</div>
        <div id="kpiIncomplete" class="value bad">-</div>
        <div class="sub">จำนวนคนที่ยังไม่ครบ 21/21</div>
      </div>

      <div class="kpi">
        <div class="label">จำนวนคนทั้งหมด</div>
        <div id="kpiTotal" class="value" style="color:rgba(234,240,255,.92)">-</div>
        <div class="sub">รายชื่อทั้งหมดในชีต People</div>
      </div>
    </div>

    <div class="weekTitle" id="weekHeader">กำลังโหลดช่วงสัปดาห์...</div>

    <table class="table">
      <thead>
        <tr>
          <th style="width:26%">ชื่อ</th>
          <th style="width:30%">% สัปดาห์</th>
          <th style="width:10%">ครบทั้งวัน</th>
          <th>สรุป 7 วัน (นับครั้ง/วัน)</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="4" class="muted">กำลังโหลด...</td></tr>
      </tbody>
    </table>

    <div class="btns">
      <a class="btn" href="/">กลับหน้าบันทึกข้อมูล</a>
      <a class="btn" href="/status.html">ไปหน้าตรวจสอบสถานะ</a>
    </div>
  </div>

  <!-- Tooltip element -->
  <div class="hoverTip" id="hoverTip" role="dialog" aria-hidden="true">
    <div class="arrow"></div>
    <div class="hdr" id="tipHdr">-</div>
    <div id="tipBody"></div>
  </div>

<script>
  // ===== CONFIG =====
  const REFRESH_MS = 60_000; // 1 นาที
  const AUTO_ON_DEFAULT = true; // เข้าเว็บมาให้เปิด auto refresh เลย

  // ===== DOM =====
  const elWeek = document.getElementById("weekHeader");
  const tbody  = document.getElementById("tbody");

  const kpiComplete = document.getElementById("kpiComplete");
  const kpiIncomplete = document.getElementById("kpiIncomplete");
  const kpiTotal = document.getElementById("kpiTotal");

  const arSwitch = document.getElementById("arSwitch");
  const arDot = document.getElementById("arDot");
  const arMode = document.getElementById("arMode");
  const arSub = document.getElementById("arSub");

  const hoverTip = document.getElementById("hoverTip");
  const tipHdr = document.getElementById("tipHdr");
  const tipBody = document.getElementById("tipBody");

  // ===== Utils =====
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function thaiDateFromISO(iso){
    const [y,m,d] = iso.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"});
  }
  function thaiShortDow(d){
    // สากลของไทยนิยมย่อ: จ. อ. พ. พฤ. ศ. ส. อา.
    const th = ["อา.","จ.","อ.","พ.","พฤ.","ศ.","ส."];
    return th[d.getDay()];
  }
  function dayGrade(count){
    if (count === 3) return "good";
    if (count === 2) return "mid";
    return "bad";
  }
  function gradeByPercent(p){
    if (p >= 90) return "good";
    if (p >= 70) return "mid";
    return "bad";
  }
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  // ===== Auto Refresh State =====
  let autoEnabled = AUTO_ON_DEFAULT;
  let timer = null;
  let countdown = Math.ceil(REFRESH_MS/1000);
  let lastLoadedAt = null;

  function refreshLabelFromMs(ms){
    const mins = Math.round(ms / 60000);
    return `ทุก ${mins} นาที`;
  }

  function updateAutoUI(){
    // switch style
    arSwitch.classList.toggle("on", autoEnabled);
    arSwitch.setAttribute("aria-checked", String(autoEnabled));

    // dot + mode
    arDot.classList.toggle("on", autoEnabled);
    arMode.textContent = autoEnabled ? "Active" : "Paused";

    // subtitle: "ทุก X นาที • รีเฟรชในอีก Y วิ" + หยุดตอนแท็บไม่ active
    const base = `Auto Refresh: ${refreshLabelFromMs(REFRESH_MS)}`;
    const hidden = document.hidden ? " • (แท็บไม่ active)" : "";
    const cd = autoEnabled && !document.hidden ? ` • รีเฟรชในอีก ${countdown} วิ` : "";
    const last = lastLoadedAt ? ` • ล่าสุด ${lastLoadedAt}` : "";
    arSub.textContent = base + cd + last + hidden;
  }

  function startAuto(){
    stopAuto();
    autoEnabled = true;
    countdown = Math.ceil(REFRESH_MS/1000);
    updateAutoUI();

    // tick ทุก 1 วิ
    timer = setInterval(async () => {
      if (!autoEnabled) return;

      // ถ้าแท็บไม่ active: หยุดนับ (กันกระแทก + กันยิงถี่)
      if (document.hidden) {
        updateAutoUI();
        return;
      }

      countdown -= 1;
      if (countdown <= 0) {
        countdown = Math.ceil(REFRESH_MS/1000);
        await load(); // รีเฟรชข้อมูล
      }
      updateAutoUI();
    }, 1000);
  }

  function stopAuto(){
    if (timer) clearInterval(timer);
    timer = null;
  }

  function setAuto(enabled){
    autoEnabled = !!enabled;
    if (autoEnabled) startAuto();
    else {
      stopAuto();
      updateAutoUI();
    }
  }

  // click + keyboard for toggle
  arSwitch.addEventListener("click", ()=> setAuto(!autoEnabled));
  arSwitch.addEventListener("keydown", (e)=>{
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      setAuto(!autoEnabled);
    }
  });

  document.addEventListener("visibilitychange", ()=>{
    // ไม่ reload ทันที แค่หยุดนับตอน hidden
    updateAutoUI();
  });

  // ===== Tooltip (fixed + clamp) =====
  let tipVisible = false;

  function buildTipHTML(dayObj){
    // dayObj: { dateISO, count, times? }
    // รองรับหลายชื่อ key เผื่อฝั่ง API ส่งมาไม่เหมือนกัน
    const times = dayObj.times || dayObj.timeMap || dayObj.sessionTimes || null;

    const getTime = (k)=>{
      if (!times) return "";
      const v = times[k];
      if (!v) return "";
      // ถ้ามาเป็น "HH:mm" หรือ "HH:mm:ss" ให้โชว์ HH:mm
      const s = String(v);
      const m = s.match(/^(\d{2}:\d{2})/);
      return (m ? m[1] : s) + " น.";
    };

    // ถ้าไม่มี times แต่มีแค่ count -> แสดงเฉย ๆ
    const hasTime = !!(times && (times.s1 || times.s2 || times.s3 || times["ครั้งที่ 1"] || times["ครั้งที่ 2"] || times["ครั้งที่ 3"]));

    const t1 = getTime("s1") || getTime("ครั้งที่ 1");
    const t2 = getTime("s2") || getTime("ครั้งที่ 2");
    const t3 = getTime("s3") || getTime("ครั้งที่ 3");

    const ok1 = !!t1;
    const ok2 = !!t2;
    const ok3 = !!t3;

    const row = (ok, label, timeText)=>`
      <div class="tipRow">
        <div class="tipLeft">
          <div class="ico ${ok ? "ok" : "no"}"><span>${ok ? "✓" : "✕"}</span></div>
          <div class="tipLabel">${label}</div>
        </div>
        <div class="tipTime">${ok ? escapeHtml(timeText) : "—"}</div>
      </div>
    `;

    return `
      ${row(ok1, "ครั้งที่ 1", t1)}
      ${row(ok2, "ครั้งที่ 2", t2)}
      ${row(ok3, "ครั้งที่ 3", t3)}
      ${!hasTime ? `<div style="margin-top:4px;font-size:12px;color:rgba(234,240,255,.70)">*ยังไม่ได้ส่งเวลาจาก API (มีแค่จำนวน ${dayObj.count||0}/3)</div>` : ``}
    `;
  }

  function showTip(anchorEl, headerText, dayObj){
    tipHdr.textContent = headerText;
    tipBody.innerHTML = buildTipHTML(dayObj);

    hoverTip.classList.add("show");
    hoverTip.setAttribute("aria-hidden","false");
    tipVisible = true;

    positionTip(anchorEl);
  }

  function hideTip(){
    hoverTip.classList.remove("show");
    hoverTip.setAttribute("aria-hidden","true");
    tipVisible = false;
  }

  function positionTip(anchorEl){
    if (!tipVisible) return;
    const r = anchorEl.getBoundingClientRect();

    // ให้ tooltip โผล่ "ใต้กล่อง" แบบกึ่งกลาง
    const tipW = hoverTip.offsetWidth || 360;
    const tipH = hoverTip.offsetHeight || 200;

    // ค่าเริ่มต้น
    let left = r.left + (r.width/2) - (tipW/2);
    let top  = r.bottom + 10;

    // clamp ซ้าย/ขวา
    left = clamp(left, 12, window.innerWidth - tipW - 12);

    // ถ้าล่างไม่พอ ให้เด้งไปด้านบน
    if (top + tipH > window.innerHeight - 12) {
      top = r.top - tipH - 10;
      top = clamp(top, 12, window.innerHeight - tipH - 12);
      // arrow ไปอยู่ด้านล่าง
      const arrow = hoverTip.querySelector(".arrow");
      arrow.style.top = "auto";
      arrow.style.bottom = "-7px";
      arrow.style.transform = "rotate(225deg)";
    } else {
      const arrow = hoverTip.querySelector(".arrow");
      arrow.style.bottom = "auto";
      arrow.style.top = "-7px";
      arrow.style.transform = "rotate(45deg)";
    }

    hoverTip.style.left = `${Math.round(left)}px`;
    hoverTip.style.top  = `${Math.round(top)}px`;

    // arrow ชี้กึ่งกลาง anchor (แต่ต้อง clamp อยู่ใน tooltip)
    const centerX = r.left + (r.width/2);
    const arrowLeft = clamp(centerX - left, 22, tipW - 22);
    hoverTip.querySelector(".arrow").style.left = `${Math.round(arrowLeft)}px`;
  }

  window.addEventListener("resize", ()=>{ if (tipVisible) hideTip(); });
  window.addEventListener("scroll", ()=>{ if (tipVisible) hideTip(); }, { passive:true });

  // ===== Render =====
  function render(out){
    const w = out.week;
    elWeek.textContent = `จันทร์ ${thaiDateFromISO(w.startISO)} – อาทิตย์ ${thaiDateFromISO(w.endISO)}`;

    const thisW = (out.summary && out.summary.thisWeek) ? out.summary.thisWeek : {};
    const peopleTotal = Number(thisW.peopleTotal || 0);
    const completePeople = Number(thisW.completePeople || 0);
    const incompletePeople = Number(thisW.incompletePeople || 0);

    kpiTotal.textContent = `${peopleTotal} คน`;
    kpiComplete.textContent = `${completePeople} คน`;
    kpiIncomplete.textContent = `${incompletePeople} คน`;

    const rows = out.people || [];
    rows.sort((a,b)=> (b.percent||0) - (a.percent||0) || String(a.name).localeCompare(String(b.name),"th"));

    tbody.innerHTML = "";

    for (const p of rows){
      const pct = Number(p.percent || 0);
      const g = gradeByPercent(pct);
      const chipText = (pct === 100) ? "ครบ 100%" : `${pct}%`;
      const doneDays = Number(p.doneDays || 0);

      const perDay = Array.isArray(p.perDay) ? p.perDay : [];
      const dayBoxes = perDay.map((d)=>{
        const cnt = Number(d.count || 0);
        const dg = dayGrade(cnt);
        const iso = String(d.dateISO || "");
        const [yy,mm,dd] = iso.split("-").map(Number);
        const dt = new Date(yy, (mm||1)-1, dd||1);
        const dow = thaiShortDow(dt);
        const dayNum = dd || "";

        // header tooltip: เช่น "พ. 4 ก.พ. 69"
        const th = dt.toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"});
        const tipHeader = `${dow} ${th}`;

        // data-json สำหรับ tooltip
        const payload = encodeURIComponent(JSON.stringify({
          dateISO: iso,
          count: cnt,
          times: d.times || d.timeMap || d.sessionTimes || null
        }));

        return `
          <div class="daybox ${dg}" data-tipheader="${escapeHtml(tipHeader)}" data-tip="${payload}">
            <div class="dayTop">
              <span class="dowBadge">${dow}</span>
              <span class="dayNum">${dayNum}</span>
            </div>
            <div class="dayCount">${cnt}/3</div>
          </div>
        `;
      }).join("");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="name">${escapeHtml(p.name||"")}</td>
        <td>
          <div class="pctRow">
            <span class="chip ${g}">
              <span class="dotMini"></span>
              <span>${chipText}</span>
            </span>
            <div class="progress ${g}">
              <i style="width:${Math.max(0, Math.min(100, pct))}%"></i>
            </div>
          </div>
          <div class="subline">ทำได้ ${p.totalDone}/${p.totalSlots} ครั้ง</div>
        </td>
        <td style="font-weight:900;font-size:16px">${doneDays}/7</td>
        <td>
          <div class="days">
            ${dayBoxes}
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }

    if (!rows.length){
      tbody.innerHTML = `<tr><td colspan="4" class="muted">ไม่พบข้อมูล</td></tr>`;
    }

    // bind tooltip events (หลัง render เสมอ)
    document.querySelectorAll(".daybox").forEach(el=>{
      el.addEventListener("mouseenter", ()=>{
        const hdr = el.getAttribute("data-tipheader") || "-";
        const raw = el.getAttribute("data-tip") || "";
        let dayObj = {};
        try { dayObj = JSON.parse(decodeURIComponent(raw)); } catch(e){}
        showTip(el, hdr, dayObj);
      });
      el.addEventListener("mousemove", ()=> positionTip(el));
      el.addEventListener("mouseleave", hideTip);
    });
  }

  // ===== Load =====
  async function load(){
    tbody.innerHTML = `<tr><td colspan="4" class="muted">กำลังโหลด...</td></tr>`;

    const res = await fetch(`/api/dashboard`);
    const out = await res.json().catch(()=>({}));

    if (!res.ok || !out.ok){
      tbody.innerHTML = `<tr><td colspan="4" class="muted">โหลดไม่สำเร็จ: ${escapeHtml(out.error||"unknown_error")}</td></tr>`;
      return;
    }

    // บันทึกเวลาที่โหลดล่าสุด
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    const ss = String(now.getSeconds()).padStart(2,"0");
    lastLoadedAt = `${hh}:${mm}:${ss}`;

    render(out);
    updateAutoUI();
  }

  // ===== Init =====
  (async function init(){
    await load();
    // เปิด auto refresh ตอนเข้าเว็บ
    setAuto(true);
  })();
</script>
</body>
</html>
