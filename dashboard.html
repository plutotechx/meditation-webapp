<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- แก้ไขล่าสุด: 2026-02-09 11:39 (+07:00) -->
  <title>Dashboard - Daily Meditation</title>

  <style>
    :root{
      --bg:#0b0d12;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.90);
      --muted:rgba(255,255,255,.55);
      --green:#30d158;
      --red:#ff4d4d;
      --amber:#ffd60a;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif;
      background: radial-gradient(1200px 900px at 40% -20%, rgba(120,140,255,.14), transparent 60%),
                  radial-gradient(900px 700px at 110% 10%, rgba(48,209,88,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding:18px;
    }

    .wrap{max-width:1200px;margin:0 auto}

    .topRow{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{
      font-size:26px;
      font-weight:1000;
      letter-spacing:.2px;
      margin:0;
    }
    .sub{
      margin:4px 0 0 0;
      color:var(--muted);
      font-weight:700;
      font-size:14px;
    }

    .controls{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, background .15s ease;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{transform:scale(.98)}

    .pill{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      padding:10px 12px;border-radius:14px;
      font-weight:900;
      color:var(--text);
      display:flex;align-items:center;gap:10px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:rgba(255,255,255,.24);
    }
    .dot.on{background:var(--green)}
    .dot.off{background:rgba(255,255,255,.24)}
    .small{font-size:13px;color:var(--muted);font-weight:800}

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin:12px 0 16px;
    }
    @media (max-width:920px){.grid2{grid-template-columns:1fr}}
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:24px;
      padding:18px 18px;
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
    }

    .bigNumber{
      font-size:62px;
      font-weight:1200;
      line-height:1;
      margin:0;
    }
    .bigNumber.green{color:var(--green)}
    .bigNumber.red{color:var(--red)}
    .label{
      margin-top:8px;
      color:rgba(255,255,255,.70);
      font-weight:900;
      font-size:14px;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 10px;
    }
    thead th{
      text-align:left;
      color:rgba(255,255,255,.72);
      font-size:13px;
      font-weight:1000;
      padding:0 10px;
      white-space:nowrap;
    }
    tbody tr{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    tbody td{
      padding:12px 10px;
      vertical-align:middle;
    }
    tbody tr td:first-child{
      border-top-left-radius:16px;
      border-bottom-left-radius:16px;
      font-weight:1000;
    }
    tbody tr td:last-child{
      border-top-right-radius:16px;
      border-bottom-right-radius:16px;
    }

    .barWrap{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      height:10px;
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background:rgba(255,255,255,.75);
      transition:width .25s ease;
    }

    .days{
      display:flex;
      gap:10px;
      justify-content:flex-start;
      flex-wrap:wrap;
    }
    .daybox{
      width:72px;
      min-height:74px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:10px;
      position:relative;
      cursor:default;
    }
    .daybox.hasTip{ cursor:pointer; }
    .daybox.hasTip:focus{ outline:2px solid rgba(255,255,255,.22); outline-offset:2px; }
    .dayTop{
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;
    }
    .dowPill{
      padding:6px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
    }
    .dayNum{
      font-size:18px;
      font-weight:1100;
      opacity:.95;
    }
    .dayMain{
      font-size:36px;
      font-weight:1200;
      line-height:1;
      text-align:center;
      margin-top:4px;
    }

    .dgGreen{
      border-color:rgba(48,209,88,.32);
      background:rgba(48,209,88,.12);
    }
    .dgRed{
      border-color:rgba(255,77,77,.28);
      background:rgba(255,77,77,.10);
    }
    .dgAmber{
      border-color:rgba(255,214,10,.28);
      background:rgba(255,214,10,.10);
    }

    /* ===== Tooltip (Small) ===== */
    .tt{position:fixed;z-index:9999;left:0;top:0;transform:translate(-9999px,-9999px);width:min(280px, calc(100vw - 24px));background:rgba(17,18,24,.92);border:1px solid rgba(255,255,255,.16);border-radius:16px;box-shadow:0 18px 55px rgba(0,0,0,.55);padding:10px;backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);pointer-events:none;}
    .tt.show{pointer-events:auto;}
    .tt .ttTitle{font-weight:1100;font-size:18px;margin:0 0 8px 0;color:rgba(234,240,255,.98);}
    .tt .ttRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);margin-top:8px;}
    .tt .ttLeft{display:flex;align-items:center;gap:10px;font-weight:1000;font-size:18px;}
    .tt .ttTime{font-weight:1100;font-size:18px;opacity:.95;}
    .tt .ico{width:34px;height:34px;border-radius:999px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.22);flex:0 0 auto;}
    .tt .ico.ok{border-color:rgba(48,209,106,.45);background:rgba(48,209,106,.18);}
    .tt .ico.bad{border-color:rgba(255,77,77,.42);background:rgba(255,77,77,.14);}
    .tt .ico svg{width:18px;height:18px;}
    .ttArrow{position:fixed;z-index:9998;width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-bottom:10px solid rgba(17,18,24,.92);transform:translate(-9999px,-9999px);filter: drop-shadow(0 6px 10px rgba(0,0,0,.55));pointer-events:none;}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topRow">
      <div>
        <h1 class="title">Dashboard</h1>
        <div id="weekLabel" class="sub">—</div>
      </div>

      <div class="controls">
        <div class="pill" title="Auto refresh 1 นาที">
          <div id="autoDot" class="dot on"></div>
          <div>Auto refresh</div>
          <div class="small">1 นาที</div>
        </div>

        <button class="btn" id="btnPrev">◀ สัปดาห์ก่อน</button>
        <button class="btn" id="btnThis">สัปดาห์นี้</button>
        <button class="btn" id="btnNext">สัปดาห์ถัดไป ▶</button>
        <button class="btn" id="btnRefresh">รีเฟรช</button>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <div class="bigNumber green" id="completePeople">0 คน</div>
        <div class="label">จำนวนคนที่ครบทุกช่วงเวลา</div>
      </div>

      <div class="card">
        <div class="bigNumber red" id="incompletePeople">0 คน</div>
        <div class="label">จำนวนคนที่ยังไม่ครบ 21/21</div>
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th style="width:220px">ชื่อ</th>
            <th style="width:120px">รวม</th>
            <th style="width:160px">%</th>
            <th>สรุป 7 วัน (นับครั้ง/วัน)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

  </div>

  <!-- ===== Tooltip ===== -->
  <div id="ttArrow" class="ttArrow" aria-hidden="true"></div>
  <div id="tt" class="tt" role="dialog" aria-hidden="true"></div>

<script>
  // ====== CONFIG ======
  const API_DASHBOARD = "/api/dashboard"; // cloudflare function
  const REFRESH_MS = 60 * 1000;

  // ====== DOM ======
  const weekLabel = document.getElementById("weekLabel");
  const completePeopleEl = document.getElementById("completePeople");
  const incompletePeopleEl = document.getElementById("incompletePeople");
  const tbody = document.getElementById("tbody");

  const btnPrev = document.getElementById("btnPrev");
  const btnThis = document.getElementById("btnThis");
  const btnNext = document.getElementById("btnNext");
  const btnRefresh = document.getElementById("btnRefresh");

  const autoDot = document.getElementById("autoDot");

  // ====== state ======
  let weekOffset = 0;
  let autoTimer = null;
  let autoOn = true;

  // ====== helpers ======
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  function escapeAttr(s){
    return String(s).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  // ===== Tooltip helpers =====
  const tt = document.getElementById("tt");
  const ttArrow = document.getElementById("ttArrow");
  let tipOpenFor = null;

  const TH_DOW_SHORT = ["อา.","จ.","อ.","พ.","พฤ.","ศ.","ส."];
  const TH_MON_SHORT = ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];

  function thaiHeaderFromISO(iso){
    const [y,m,d] = String(iso||"").split("-").map(Number);
    if (!y || !m || !d) return "";
    const dt = new Date(y, m-1, d);
    const dow = TH_DOW_SHORT[dt.getDay()] || "";
    const mon = TH_MON_SHORT[m-1] || "";
    const yy = (y + 543) % 100;
    return `${dow} ${d} ${mon} ${String(yy).padStart(2,"0")}`;
  }

  function cleanHHmm(s){
    s = String(s||"").trim();
    if (!s) return "";
    const m = s.match(/(\d{1,2}):(\d{2})/);
    if (!m) return "";
    return `${m[1].padStart(2,"0")}:${m[2]}`;
  }

  function iconSvg(ok){
    return ok
      ? `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 7L10.5 16.5L4 10" stroke="white" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`
      : `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 7l10 10M17 7L7 17" stroke="white" stroke-width="2.6" stroke-linecap="round"/></svg>`;
  }

  function buildTipHtml(payload){
    const head = thaiHeaderFromISO(payload.dateISO);
    const s = payload.sessions || {};
    const rows = [
      { label:"ครั้งที่ 1", ok: !!s.s1?.done, time: cleanHHmm(s.s1?.time) },
      { label:"ครั้งที่ 2", ok: !!s.s2?.done, time: cleanHHmm(s.s2?.time) },
      { label:"ครั้งที่ 3", ok: !!s.s3?.done, time: cleanHHmm(s.s3?.time) },
    ];
    const htmlRows = rows.map(r=>{
      const t = r.ok ? (r.time ? `${r.time} น.` : "—") : "—";
      return `
        <div class="ttRow">
          <div class="ttLeft">
            <div class="ico ${r.ok ? "ok" : "bad"}">${iconSvg(r.ok)}</div>
            <div>${r.label}</div>
          </div>
          <div class="ttTime">${t}</div>
        </div>
      `;
    }).join("");
    return `<div class="ttTitle">${escapeHtml(head)}</div>${htmlRows}`;
  }

  function hideTip(){
    tt.classList.remove("show");
    tt.setAttribute("aria-hidden","true");
    tt.style.transform = "translate(-9999px,-9999px)";
    ttArrow.style.transform = "translate(-9999px,-9999px)";
    tipOpenFor = null;
  }

  function showTipFor(el){
    const raw = el.getAttribute("data-tt") || "";
    if (!raw) return;
    let payload = null;
    try{ payload = JSON.parse(raw); }catch(e){ payload = null; }
    if (!payload || !payload.dateISO) return;

    tt.innerHTML = buildTipHtml(payload);
    tt.classList.add("show");
    tt.setAttribute("aria-hidden","false");

    const r = el.getBoundingClientRect();
    const vw = window.innerWidth;
    const pad = 10;

    const w = tt.offsetWidth || 280;
    const h = tt.offsetHeight || 160;

    let left = r.left + (r.width/2) - (w/2);
    left = Math.max(pad, Math.min(left, vw - w - pad));

    let top = r.bottom + 14;
    if (top + h + pad > window.innerHeight){
      top = r.top - h - 14;
    }

    tt.style.transform = `translate(${Math.round(left)}px, ${Math.round(top)}px)`;

    const arrowLeft = Math.max(pad, Math.min(r.left + r.width/2 - 9, vw - pad - 18));
    const arrowTop = (top > r.bottom) ? (r.bottom + 4) : (r.top - 12);

    if (top < r.top){
      ttArrow.style.borderBottom = "0";
      ttArrow.style.borderTop = "10px solid rgba(17,18,24,.92)";
    } else {
      ttArrow.style.borderTop = "0";
      ttArrow.style.borderBottom = "10px solid rgba(17,18,24,.92)";
    }
    ttArrow.style.transform = `translate(${Math.round(arrowLeft)}px, ${Math.round(arrowTop)}px)`;

    tipOpenFor = el;
  }

  function dowShort(i){
    return ["จ.","อ.","พ.","พฤ.","ศ.","ส.","อา."][i] || "";
  }

  function fmtRange(week){
    // week.startISO / endISO -> แสดงเป็น ISO เดิม (คุมความชัวร์)
    return `Week: ${week.startISO} ถึง ${week.endISO}`;
  }

  function colorClass(cnt){
    if (cnt >= 3) return "dgGreen";
    if (cnt >= 1) return "dgAmber";
    return "dgRed";
  }

  function isoToDowDay(iso){
    const [y,m,d] = iso.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    // getDay: 0=Sun ... 6=Sat -> convert to Thai short above that uses Mon first
    const js = dt.getDay();
    const map = {0:6,1:0,2:1,3:2,4:3,5:4,6:5};
    const idx = map[js];
    return { dow: dowShort(idx), day: d };
  }

  async function load(){
    const u = `${API_DASHBOARD}?weekOffset=${encodeURIComponent(String(weekOffset))}&_=${Date.now()}`;
    const r = await fetch(u, { cache:"no-store" });
    const j = await r.json();
    if (!j || !j.ok) throw new Error("API error");
    render(j);
  }

  function render(data){
    weekLabel.textContent = fmtRange(data.week);

    const sum = data.summary?.thisWeek || {};
    completePeopleEl.textContent = `${sum.completePeople || 0} คน`;
    incompletePeopleEl.textContent = `${sum.incompletePeople || 0} คน`;

    const rows = data.people || [];
    tbody.innerHTML = rows.map(p=>{
      const percent = Number(p.percent || 0);
      const barW = Math.max(0, Math.min(100, percent));

      const dayBoxes = (p.perDay || []).map(d=>{
        const cnt = Number(d.count || 0);
        const dg = colorClass(cnt);
        const { dow, day } = isoToDowDay(d.dateISO);

        return `
          <div class="daybox ${dg} hasTip" tabindex="0" role="button"
               data-tt="${escapeAttr(JSON.stringify({dateISO: iso, sessions: d.sessions || null}))}">
             <div class="dayTop">
               <div class="dowPill">${escapeHtml(dow)}</div>
               <div class="dayNum">${day}</div>
             </div>
             <div class="dayMain">${cnt}/3</div>
          </div>
        `;
      }).join("");

      return `
        <tr>
          <td>${escapeHtml(p.name || "")}</td>
          <td><b>${p.totalDone || 0}</b>/<span class="small">21</span></td>
          <td>
            <div style="display:flex;align-items:center;gap:10px">
              <div class="barWrap" style="flex:1">
                <div class="bar" style="width:${barW}%"></div>
              </div>
              <div style="min-width:44px;font-weight:1000">${percent}%</div>
            </div>
          </td>
          <td><div class="days">${dayBoxes}</div></td>
        </tr>
      `;
    }).join("");
  }

  function startAuto(){
    stopAuto();
    if (!autoOn) return;
    autoDot.classList.remove("off");
    autoDot.classList.add("on");
    autoTimer = setInterval(()=>load().catch(()=>{}), REFRESH_MS);
  }
  function stopAuto(){
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;
  }
  function setAuto(on){
    autoOn = !!on;
    if (autoOn){
      startAuto();
    } else {
      stopAuto();
      autoDot.classList.remove("on");
      autoDot.classList.add("off");
    }
  }

  // ===== Tooltip events (event delegation) =====
  tbody.addEventListener("mouseover", (e)=>{
    const box = e.target.closest(".daybox.hasTip");
    if (!box) return;
    showTipFor(box);
  });
  tbody.addEventListener("mouseout", (e)=>{
    const from = e.target.closest(".daybox.hasTip");
    const to = e.relatedTarget ? e.relatedTarget.closest(".daybox.hasTip") : null;
    if (from && from !== to) hideTip();
  });
  tbody.addEventListener("click", (e)=>{
    const box = e.target.closest(".daybox.hasTip");
    if (!box) return;
    if (tipOpenFor === box) hideTip();
    else showTipFor(box);
  });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") hideTip(); });
  window.addEventListener("scroll", hideTip, { passive:true });
  window.addEventListener("resize", hideTip);

  // ====== init =====
  btnPrev.addEventListener("click", ()=>{ weekOffset -= 1; load(); });
  btnNext.addEventListener("click", ()=>{ weekOffset += 1; load(); });
  btnThis.addEventListener("click", ()=>{ weekOffset = 0; load(); });
  btnRefresh.addEventListener("click", ()=>load());

  document.querySelector(".pill").addEventListener("click", ()=>{
    setAuto(!autoOn);
  });

  load().then(()=>startAuto()).catch(err=>{
    console.error(err);
  });
</script>
</body>
</html>
