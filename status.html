<script>
  const nameSel = document.getElementById("nameSel");
  const dateSel = document.getElementById("dateSel");
  const btn = document.getElementById("checkBtn");
  const out = document.getElementById("out");

  function esc(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  btn.addEventListener("click", async () => {
    out.className = "msg";
    out.textContent = "กำลังตรวจสอบ...";

    const name = (nameSel.value || "").trim();
    const logDate = (dateSel.value || "").trim(); // ต้องเป็น YYYY-MM-DD

    if (!name || !logDate) {
      out.className = "msg bad";
      out.textContent = "กรุณาเลือกรายชื่อ และ วันที่ต้องการตรวจสอบ";
      return;
    }

    try {
      const q = new URLSearchParams({ name, logDate });
      const res = await fetch(`/api/checkStatus?${q.toString()}`, { method:"GET" });
      const data = await res.json().catch(()=>({}));

      if (!res.ok || !data.ok) {
        out.className = "msg bad";
        out.textContent = `ตรวจสอบไม่สำเร็จ: ${data.error || "unknown_error"}`;
        return;
      }

      // ✅ ตัวอย่างการแสดงผล (ปรับได้)
      // คาดว่า GAS ส่งกลับ {ok:true, name, logDate, doneCount, sessions:{s1:"...",s2:"...",s3:"..."}}
      out.className = "msg ok";
      out.innerHTML =
        `วันที่ ${esc(data.logDate)} | ${esc(data.name)}\n` +
        `สถานะ: ทำแล้ว ${esc(data.doneCount || 0)}/3\n` +
        `ครั้งที่ 1: ${esc(data.sessions?.s1 || "—")}\n` +
        `ครั้งที่ 2: ${esc(data.sessions?.s2 || "—")}\n` +
        `ครั้งที่ 3: ${esc(data.sessions?.s3 || "—")}`;
    } catch (e) {
      out.className = "msg bad";
      out.textContent = `ตรวจสอบไม่สำเร็จ: ${e}`;
    }
  });
</script>
