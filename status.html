<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Status - Daily Meditation</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.75);
      --input:rgba(0,0,0,.22);
      --btn:#6aa9ff;
      --btnText:#081122;
      --danger:#ff6a6a;
      --ok:#65ffb3;
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      margin:0;
      background:var(--bg);
      color:var(--text)
    }
    .wrap{max-width:820px;margin:0 auto;padding:24px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px
    }
    h1{margin:0 0 6px;font-size:22px}
    .muted{color:var(--muted);margin:0 0 16px;line-height:1.55}
    label{display:block;margin:12px 0 6px}
    select{
      width:100%;box-sizing:border-box;border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:var(--input);color:#fff;
      padding:12px 12px;outline:none
    }
    button{
      margin-top:14px;width:100%;
      padding:12px 14px;border:0;border-radius:14px;
      background:var(--btn);color:var(--btnText);
      font-weight:900;cursor:pointer
    }
    button:disabled{opacity:.6;cursor:not-allowed}

    .msg{margin-top:12px;min-height:22px;white-space:pre-line}
    .msg.ok{color:var(--ok)}
    .msg.bad{color:var(--danger)}

    .topline{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    a.btnlink{flex:1;text-decoration:none}
    a.btnlink button{
      width:100%;
      background:rgba(255,255,255,.10);
      color:var(--text);
      border:1px solid rgba(255,255,255,.14)
    }

    /* ===== Result Header ===== */
    .resultHeader{
      margin-top:14px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      line-height:1.6;
      font-weight:900;
    }
    .resultHeader .sub{
      font-weight:800;
      color:rgba(234,240,255,.78);
      margin-top:4px;
    }

    /* ===== 4 Boxes ===== */
    .boxes{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:760px){
      .boxes{grid-template-columns:repeat(2, minmax(0,1fr))}
    }

    .box{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      padding:12px 12px 12px;
      min-height:104px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      box-shadow:0 14px 40px rgba(0,0,0,.25);
    }
    .boxTitle{
      font-weight:1000;
      color:rgba(234,240,255,.92);
      font-size:13px;
      letter-spacing:.2px;
    }

    .statusRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:8px;
      font-weight:1000;
    }

    /* ทำให้อ่านง่ายขึ้น: เวลาใหญ่ขึ้น */
    .time{
      font-weight:1000;
      font-size:18px;
      letter-spacing:.2px;
    }
    .time.muted{
      color:rgba(234,240,255,.55);
      font-weight:900
    }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:36px;height:36px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .badge.ok{
      border-color:rgba(101,255,179,.40);
      background:rgba(101,255,179,.12);
    }
    .badge.bad{
      border-color:rgba(255,106,106,.40);
      background:rgba(255,106,106,.12);
    }

    /* Summary box: แค่ 1/3 */
    .sumBig{
      font-size:34px;
      font-weight:1100;
      line-height:1;
      margin-top:6px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>ตรวจสอบสถานะ</h1>
      <p class="muted" id="weekHeader">กำลังคำนวณช่วงสัปดาห์...</p>

      <label>รายชื่อ</label>
      <select id="nameSel">
        <option value="">กำลังโหลดรายชื่อ...</option>
      </select>

      <label>วันที่ต้องการตรวจสอบ</label>
      <select id="dateSel"></select>

      <button id="checkBtn" type="button">ตรวจสอบสถานะ</button>

      <div class="msg" id="out"></div>

      <div class="topline">
        <a class="btnlink" href="/"><button type="button">กลับหน้าบันทึกข้อมูล</button></a>
        <!-- ✅ เอาปุ่มไป Dashboard ออกตามที่ขอ -->
      </div>
    </div>
  </div>

<script>
  const weekHeaderEl = document.getElementById("weekHeader");
  const nameSel = document.getElementById("nameSel");
  const dateSel = document.getElementById("dateSel");
  const btn = document.getElementById("checkBtn");
  const out = document.getElementById("out");

  const TH_DOW = ["จันทร์","อังคาร","พุธ","พฤหัส","ศุกร์","เสาร์","อาทิตย์"];

  function pad2(n){ return String(n).padStart(2,"0"); }
  function toISODateLocal(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function thaiDateLabelLocal(d){
    return d.toLocaleDateString("th-TH", { day:"numeric", month:"short", year:"2-digit" });
  }
  function mondayOfWeekLocal(d){
    const x = new Date(d); x.setHours(0,0,0,0);
    const day = x.getDay(); // Sun=0
    const diff = (day===0) ? -6 : (1-day);
    x.setDate(x.getDate()+diff);
    return x;
  }

  // ✅ กำหนดช่วง จันทร์-อาทิตย์ จากเครื่องผู้ใช้ (Local)
  function showWeekHeader(){
    const now = new Date();
    const mon = mondayOfWeekLocal(now);
    const sun = new Date(mon); sun.setDate(mon.getDate()+6);
    weekHeaderEl.textContent = `จันทร์ ${thaiDateLabelLocal(mon)} – อาทิตย์ ${thaiDateLabelLocal(sun)}`;
  }

  function buildDateOptions(){
    const now = new Date();
    const mon = mondayOfWeekLocal(now);
    const todayISO = toISODateLocal(now);

    dateSel.innerHTML = "";
    for (let i=0;i<7;i++){
      const d = new Date(mon); d.setDate(mon.getDate()+i);
      const iso = toISODateLocal(d);
      const label = `${TH_DOW[i]} ${thaiDateLabelLocal(d)}${iso===todayISO ? " (วันนี้)" : ""}`;
      const opt = document.createElement("option");
      opt.value = iso;
      opt.textContent = label;
      dateSel.appendChild(opt);
    }
    dateSel.value = todayISO;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // ===== normalize session output to (done, timeText) =====
  function normalizeSession(v){
    // รองรับทั้ง object และ string
    if (v && typeof v === "object") {
      const done = !!v.done;
      const time = (v.time || "").toString().trim();

      // ✅ เพิ่ม "น." ถ้ามีเวลา
      const timeText = time ? `${time} น.` : "—";
      return { done, timeText };
    }

    const s = (v ?? "").toString().trim();
    if (!s || s === "—" || s === "-") return { done:false, timeText:"—" };

    // หาเวลา HH:MM
    const m = s.match(/(\d{1,2}:\d{2})/);
    const timeText = m ? `${m[1]} น.` : "—";

    // เดา done จากสัญลักษณ์/คำ
    const done = /✅|done|ครบ|true/i.test(s);
    return { done, timeText };
  }

  function iconSvg(type){
    if (type === "ok") {
      return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M20 7L10.5 16.5L4 10" stroke="#65ffb3" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
    }
    return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M18 6L6 18M6 6l12 12" stroke="#ff6a6a" stroke-width="2.6" stroke-linecap="round"/>
    </svg>`;
  }

  function renderBoxes(data){
    const s1 = normalizeSession(data.sessions?.s1);
    const s2 = normalizeSession(data.sessions?.s2);
    const s3 = normalizeSession(data.sessions?.s3);

    const doneCount = Number.isFinite(Number(data.doneCount))
      ? Number(data.doneCount)
      : [s1.done, s2.done, s3.done].filter(Boolean).length;

    const dateISO = (data.logDate || "").toString();
    const name = (data.name || "").toString();

    const headerHtml = `
      <div class="resultHeader">
        <div>วันที่ ${escapeHtml(dateISO)} | ${escapeHtml(name)}</div>
        <div class="sub">สถานะรวม: ทำแล้ว <span style="color:var(--ok)">${doneCount}</span>/3</div>
      </div>
    `;

    const boxHtml = (title, st) => {
      const cls = st.done ? "ok" : "bad";
      const timeCls = (st.timeText === "—") ? "time muted" : "time";
      return `
        <div class="box">
          <div class="boxTitle">${escapeHtml(title)}</div>
          <div class="statusRow">
            <div class="${timeCls}">${escapeHtml(st.timeText)}</div>
            <div class="badge ${cls}">${iconSvg(cls)}</div>
          </div>
        </div>
      `;
    };

    // ✅ กล่องสรุป: โชว์แค่ 1/3 ตามที่ขอ
    const sumBox = `
      <div class="box">
        <div class="boxTitle">สรุป</div>
        <div class="sumBig" style="color:var(--ok)">${doneCount}/3</div>
      </div>
    `;

    out.className = "";
    out.innerHTML = `
      ${headerHtml}
      <div class="boxes">
        ${boxHtml("ครั้งที่ 1", s1)}
        ${boxHtml("ครั้งที่ 2", s2)}
        ${boxHtml("ครั้งที่ 3", s3)}
        ${sumBox}
      </div>
    `;
  }

  async function loadNames(){
    nameSel.innerHTML = `<option value="">กำลังโหลดรายชื่อ...</option>`;
    try {
      const res = await fetch("/api/names");
      const data = await res.json().catch(()=>({}));

      if (!res.ok || !data.ok) {
        nameSel.innerHTML = `<option value="">โหลดรายชื่อไม่สำเร็จ</option>`;
        out.className = "msg bad";
        out.textContent = `โหลดรายชื่อไม่สำเร็จ: ${data.error || "unknown_error"}`;
        return;
      }

      const names = Array.isArray(data.names) ? data.names : [];
      nameSel.innerHTML =
        `<option value="">— เลือกชื่อ —</option>` +
        names.map(n => `<option>${escapeHtml(n)}</option>`).join("");

    } catch (e) {
      nameSel.innerHTML = `<option value="">โหลดรายชื่อไม่สำเร็จ</option>`;
      out.className = "msg bad";
      out.textContent = `โหลดรายชื่อไม่สำเร็จ: ${e}`;
    }
  }

  btn.addEventListener("click", async () => {
    out.className = "msg";
    out.textContent = "กำลังตรวจสอบ...";

    const name = (nameSel.value || "").trim();
    const logDate = (dateSel.value || "").trim(); // YYYY-MM-DD

    if (!name || !logDate) {
      out.className = "msg bad";
      out.textContent = "กรุณาเลือกรายชื่อ และ วันที่ต้องการตรวจสอบ";
      return;
    }

    try {
      const q = new URLSearchParams({ name, logDate });
      const res = await fetch(`/api/checkStatus?${q.toString()}`);
      const data = await res.json().catch(()=>({}));

      if (!res.ok || !data.ok) {
        out.className = "msg bad";
        out.textContent = `ตรวจสอบไม่สำเร็จ: ${data.error || "unknown_error"}`;
        return;
      }

      renderBoxes(data);

    } catch (e) {
      out.className = "msg bad";
      out.textContent = `ตรวจสอบไม่สำเร็จ: ${e}`;
    }
  });

  showWeekHeader();
  buildDateOptions();
  loadNames();
</script>
</body>
</html>
